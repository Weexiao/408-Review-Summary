# 一些重点协议

## 物理层

Rj45，802.3

## 数据链路层

SDLC，HDLC，PPP，STP和帧中继等

### 随机访问介质访问控制

所有用户都可随时发送数据，可占全部带宽

#### ALOHA协议

##### 纯ALOHA协议

思想：不监听信道，不按时间槽发送，随机发送，想发就发

每个帧在到达后，在缓存中等小于$T_0$时间后才能发送出去

冲突如何检测：如果发生冲突，接收方就会检测出冲突然后不予确认(NAK或不发)，发送方在一定时间收不到就判定发生冲突：

冲突如何解决：超时后等一随机时间再发，可能立刻发也可能过一会再发

> 吞吐量：$S=Ge^{-2G}$，G为$T_0$时间内所有站点发送成功的和未成功而重传的帧数，S为吞吐量，其max值为$G=0.5$时$S=0.184$，可见吞吐量巨低
>
> ![image-20220808194602215](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808194602215.png)

##### 时隙ALOHA协议

思想：将时间分为若干时间片，所有用户在时间片开始时刻同步接入网络信道，若发送冲突，则必须等到下一个时间片开始时刻再发送

![image-20220808194803277](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808194803277.png)

> 时隙ALOHA吞吐量大约是纯ALOHA协议的2倍，即0.368

#### CSMA协议(载波监听多路访问协议)—先听再说

CS：载波监听，每个站在**发送数据之前**要检查一下总线上是否有其他计算机在发送数据

> 当几个站同时发数据时，线路上可能会出现电压超过阈值的情况，我们将这种时刻看成出现碰撞

MA：多点接入，表示许多计算机以**多点接入的方式连接在一根总线上**

思想：发送前先监听信道，空闲则发送完整帧，忙则推迟发送

![CSMA协议](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/CSMA%E5%8D%8F%E8%AE%AE-16601305757642.png)

> 三种不同类型的CSMA协议比较
>
> | 信道状态 |           1-坚持CSMA           |               非坚持CSMA               |                          p-坚持CSMA                          |
> | :------: | :----------------------------: | :------------------------------------: | :----------------------------------------------------------: |
> |   空闲   | 信道空闲则直接发送，不需要等待 |     信道空闲则直接发送，不需要等待     | 信道空闲则以p概率直接发送，以1-p概率等到下一个时间槽再发送(p=1时退化成1-坚持CSMA) |
> |    忙    |          忙则一直监听          | 忙则放弃监听，等待随机一端时间后再监听 |                    忙则一直监听，直到空闲                    |

#### CSMA/CD协议(载波监听多点接入/碰撞检测协议)—边说边听

采用隐式ACK(无人确认)，CSMA+CD(碰撞检测)

CS：载波监听，每个站在**发送数据之前**和**发送数据时**要检查一下总线上是否有其他计算机在发送数据

MA：多点接入，表示许多计算机以多点接入的方式连接在一根总线上(总线型网络)

CD：碰撞检测(冲突检测)，“**边发送边监听**”，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据(**半双工网络**)

##### 传播时延对载波监听的影响

即在超过RTT的时间内还未检测到碰撞，则此次发送一定没有碰撞

![image-20220810193309070](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220810193309070.png)

##### 如何确定碰撞发送后重传时机

截断二进制指数规避算法

1. 确定基本退避(推迟)时间为争用期$2\tau=1RTT$
2. 定义参数$k$，它等于重传次数，但$k$不超过10，即$k=min(重传次数，10)$
3. 从离散的整数集合${0,1,2,\dots,2^k-1}$中随机取一个数$r$，重传推迟时间是$2 \tau * r$
4. 当重传次数超过16次还不成功时，视为网络拥堵，认为该帧永远无法发出，抛弃此帧并向上层报错

> ![image-20220810193900853](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220810193900853.png)
> $$
> \begin{aligned}
> & \because 11 \gt 10 \\
> & \therefore k=10 \qquad \therefore 0-2^{10}-1
> \end{aligned}
> \tag{1}
> $$

##### 最小帧长问题

用来在检测到碰撞时可以掐断传输，若过短则可能检测到碰撞时已经发完了

==帧的传输时延至少要两倍于信号(数字或模拟)在总线中的传播时延==
$$
\begin{aligned}
& \because \frac{帧长}{数据传输速率} \ge 2 \tau=1RTT \\
& \therefore 帧长 \ge 2 \tau * 数据传输速率
\end{aligned}
\tag{1}
$$
**以太网最短帧长为64B**，小于64B的一律视为无效帧

#### CSMA/CA协议(载波监听多点接入/碰撞避免协议)—边说边听

CA多用于无线，无法360°检测碰撞，存在隐蔽站

使用显式ACK

> 隐蔽站：三个结点A、B、C
>
> 对A来说C就是一个隐蔽站，当A、C都检测到信道空闲时，同时向B发信号就会冲突

##### 原理

1. 发送数据前，先检测信道是否空闲
2. 空闲则发出**RTS(request to send)**，**RTS**包括**发送端的地址、接受端的地址、下一份数据将持续发送的时间等信息**，信道忙则等待  
3. 接受端收到**RTS**后，将响应**CTS(clear to send)**
4. 发送端收到**CTS**后，开始发送数据帧(同时预约信道：发送方告诉其他站点自己要传多久数据)
5. 接收端收到数据帧后，将用CRC(循环冗余检验)来检验数据是否正确，正确则响应**ACK**帧
6. **发送方收到ACK就可以进行下一个数据帧的发送，若没有就一直重传至规定重发次数为止**(采用**二进制指数规避算法**来确定随机的推迟时间)

主要有三个内容：预约信道，ACK确认帧，RTS/CTS帧  

#### ALOHA、CSMA、CSMA/CD、CSMA/CA对比学习

1. ALOHA协议可以分为纯ALOHA协议(想啥时候发就啥时候发)和时隙ALOHA协议(在同步时间片内随便发)，这两种协议都可以看成想发啥发啥，其主要的缺点是吞吐量低，分别是0.184和0.368

2. CSMA、CSMA/CD、CSMA/CA协议本质思想是一致的，都是边听边说

	CSMA主要有三种分别是1-坚持CSMA、非坚持CSMA和p-坚持CSMA，1-坚持CSMA特点是信道空闲就直接发忙的时候也要一直听直到空闲，而非坚持CSMA特点是若信道忙则等待一个随机时间后再听，p-坚持CSMA则是在信道空闲时以p概率直接发送已1-p概率等到下一个时间槽再发(若p=1则p-坚持退化为1-坚持)；**CSMA协议与其余两种协议的区别主要在于若出现碰撞，CSMA会一直发完本帧，而CSMA/CD和CSMA/CA则会在检测到出现碰撞时停止发送**

	CSMA/CD协议和CSMA/CA协议的异同点主要在于

	- 相同点：CSMA/CD和CSMA/CA都从属于CSMA协议的思路，都是先听再说
	- 不同点
		1. 传输介质不同：CSMA/CD协议用于总线式以太网(有线)，而CSMA/CA协议用于无线局域网(无线)
		2. 载波检测方式不同：CSMA/CD通过电缆中电压高低来检测；而CSMA/CA通过能量检测(ED)、载波检测(CS)和能量载波混合检测三种方式检测信道空闲的方式
		3. CSMA/CD检测冲突，CSMA/CA避免冲突，二者出现冲突后都会进行有上限的重传
		4. CSMA/CD采用隐式ACK无人确认，CSMA/CA采用显式确认真有人确认

### PPP协议与HDLC协议

二者一般用于广域网

#### 广域网(WAN)

物理范围大如Internet，**通信子网使用分组交换技术**，可用公用分组交换网、卫星通讯网、无线分组交换网，将各地局域网连接起来达到资源共享的目的

> 广域网最顶层为网络层，局域网最顶层为链路层

![image-20220815194258247](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815194258247.png)

#### PPP协议

点对点，使用字符，使用最广泛(拨号上网)，**只支持全双工链路**，**面向串行链路**

**要求**

1. 简单：对链路层帧无纠错，无序号，无流量控制
2. 封装成帧
3. 透明传输：处理帧中非法字符，如同步线路使用比特填充法、异步线路使用字节填充法
4. 多种网络层协议：对上次IP协议无所谓
5. 多种类型链路：连接的链路类型无所谓
6. 差错检测：使用CRC循环冗余检验，若错就丢弃
7. 检测链路连接状态：链路是否正常工作
8. 最大数据传输单元：MTU$\le$1500
9. 网络层地址协商：让双方确认对方网络层地址
10. 数据压缩协商

PPP协议**无需**纠错、流量控制、不进行编号、不支持多点通信

**主要的三个功能/三个组成部分**

1. 链路控制协议LCP：一种扩展链路控制协议，用于建立、配置、测试和管理数据链路
2. 网络控制协议NCP：PPP可以支持多种网络层协议，每个不同的网络层协议都有一个相应的NCP来配置，为网络层协议建立和配置逻辑连接
3. 一个将IP数据报封装到串行链路(可能是同步的也可能是异步的)的方法：IP数据报即PPP数据帧的数据部分，其长度受MTU的限制

**状态**

![image-20220815195811322](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815195811322.png)

**帧格式**

![image-20220815195913110](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815195913110.png)

- F：7E为16进制，即01111110，一个填充字段
- A：地址字段，固定为11111111
- C：控制字段，固定为00000011
- 协议：表示信息部分是什么，到底是IP数据报还是LCP数据还是网络控制数据
- IP数据报中的转义字符为TD=01111101
- FCS：CRC循环冗余检验余数
- F：同第一个字段，为字符填充字段

#### HDLC协议

点对点，**面向比特**，不属于TCP/IP协议组，由ISO制定；**可透明传输，0比特插入法**，易硬件实现；**使用全双工通信**；所有帧都采用CRC检验，对信息帧进行顺序编号，可防止漏传或重发，传输可靠性高

**站的分类**

![HDLC的站](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/HDLC%E7%9A%84%E7%AB%99.png)

**三种数据操作方式**

1. 正常响应方式
2. 异步平衡：每个复合站都可以发
3. 异步响应：从站可以随便发

**帧格式**

![image-20220816192549941](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220816192549941.png)

- 标志F 8位：标志帧开始

- 地址A 8位：可用从站或应答站的地址

- 控制C 8位：

	信息帧：第一位为0，用来传输数据信息，或使用捎带技术对数据进行确认

	监督帧：10，用于流量控制和差错控制，执行对信息帧的确认、请求重发或请求暂停发送等

	无编号帧：11，用于提供对链路的建立、拆除等多种控制功能

- 注意在透明传输区间使用了0比特插入法，即5个连续的1插入一个0

#### PPP协议与HDLC协议异同点

相同点

- 两者都全双工

- 两者都实现了透明传输

	PPP在异步传输时使用字符填充，同步时使用比特填充；HDLC使用0比特填充法

- 都使用CRC进行差错检验，但其不会纠正

不同点

| PPP协议  | 面向字符 | 帧中有2B协议字段 | 帧无编号 | 不可靠 |
| -------- | -------- | ---------------- | -------- | ------ |
| HDLC协议 | 面向比特 | 无               | 帧有编号 | 可靠   |

## 网络层

### IP

使用IP协议来完成网络层，主要有IP地址等内容

### IPX

IPX 是指互联网分组交换协议，提供分组寻址和选择路由的功能，保证可靠到达，相当于数据报的功能

### ICMP

ICMP是一个网络层协议，在网络层和传输层之间交换信息(更有效地转发IP数据报和提高交付机会)

支持主机/路由器；有差错报告；有网络探询

### IGMP

网络层协议，使用IP数据报传输

**让路由器知道本局域网上某个主机是否参与或退出了某个组播组**

组播路由器知道的成员关系仅仅是本局域网上是否有组播组的成员

### ARP

无论网络层使用什么协议，在实际网络的链路上传输数据帧时，最终都必须使用硬件地址。所以需要一致方法来**完成IP地址到MAC地址的映射**，这就是地址解析协议ARP

### RARP

ARP的逆过程

### OSPF

开放最短路径优先OSPF协议，使用Dijskra算法

特征：分布式的链路状态算法

![image-20220829192124684](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829192124684.png)

## 传输层

### TCP

1. 面向连接(虚连接)的传输层协议

2. 每条TCP连接只能有两个端点，每条TCP连接只能是点对点的

3. 提供可靠交付的服务，无差错、不丢失、不重复、按序道道

4. 提供全双工通信

	发送缓存：准备发送的数据 & 发送但未收到确认的数据

	接受缓存：按序到达但未被应用程序读取的数据 & 不按序到达的数据

5. 面向字节流，将数据看成一连串的无结构字节流

### UDP

UDP只在IP上加了很少的功能，即复用分用+差错检测

**特点**

1. UDP是无连接的，减少开销和发送数据之前的时延

2. UDP尽最大努力传输，即不保证可靠传输，可靠交付由应用层保证

3. UDP是面向报文的，适合一次性传输少量数据的网络应用

	UDP的对应用层报文不切分，不处理，直接传输，由应用层决定UDP报文长度，否则网络层会分配；若太小则数据传输率低，太大则网络层分片

	![image-20220831192904089](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220831192904089.png)

4. UDP无拥塞控制，实时性强，适用于FaceTime等

5. 首部开销小，只有8B，而TCP20B

### NAT

NAT：通过专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址。它使得整个专用网只需要一个全球IP地址就可以与因特网联通。

## 应用层

### 重点应用层协议

| 常用协议 |                             功能                             | 下层使用什么实现 |                            端口号                            |
| :------: | :----------------------------------------------------------: | :--------------: | :----------------------------------------------------------: |
|   DNS    |                      将域名转换为IP地址                      |                  |                              53                              |
|   TFTP   |                         简单文件传输                         |       UDP        |                              69                              |
|   FTP    | 提供不同种类主机系统之间的文件传输，可以将上传、下载看作不同方向的拷贝；基于C/S模型 |       TCP        | 21端口监听客户端连接；20端口传输数据(按照传输模式来看是否使用20端口) |
|   SMTP   | **规定了两个相互通信的SMTP进程之间应如何交换信息**，发的为SMTP客户端，收的为SMTP服务器；多用于邮件发送 |       TCP        |                              25                              |
|   POP3   |                        多用于接收邮件                        |       TCP        |                             110                              |
|  TELNET  |                           远程登录                           |       TCP        |                              23                              |
|   HTTP   | 超文本传输协议；规定了浏览器如何向万维网服务器请求万维网文档，已经服务器怎样把文档传送给浏览器 |       TCP        |                              80                              |
|   SNMP   | 用于在 IP 网络管理[网络节点](https://baike.baidu.com/item/网络节点?fromModule=lemma_inlink)（[服务器](https://baike.baidu.com/item/服务器?fromModule=lemma_inlink)、[工作站](https://baike.baidu.com/item/工作站?fromModule=lemma_inlink)、[路由器](https://baike.baidu.com/item/路由器?fromModule=lemma_inlink)、[交换机](https://baike.baidu.com/item/交换机?fromModule=lemma_inlink)及HUBS等）的一种标准协议 |       UDP        |                             161                              |

### 无状态协议和有状态协议

|            |                          无状态协议                          |                          有状态协议                          |
| :--------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|    定义    | 无状态协议是一种网络协议，**其中客户端将请求发送到服务器，服务器根据给定状态返回响应** | 有状态协议是一种网络协议，其中，**如果客户端向服务器发送请求，则它期望某种响应，如果没有响应，则它重新发送该请求** |
|    例子    | HTTP（超文本传输协议），UDP（用户数据报协议），DNS（域名系统） |                 FTP（文件传输协议），Telnet                  |
| 服务器限制 | **在“无状态”中，不需要服务器将服务器信息或会话详细信息保留给自己** |       **在有状态时，需要服务器维护当前状态和会话信息**       |
|   相依性   | 在无状态情况下，服务器和客户端之间是松散耦合的，可以独立运行 |            在有状态时，服务器和客户端是紧密绑定的            |
|    设计    |                      服务器设计易于实现                      |                 服务器设计相对复杂且难以实施                 |
|  防撞证明  |                故障服务器可以在崩溃后轻松重启                |     服务器必须保留会话信息和其他详细信息。崩溃管理很困难     |
|  事务次数  |                 服务器以非常快的方式处理事务                 |                         服务器比较慢                         |

### DHCP

DHCP是一个应用层协议，使用客户/服务端协议，客户端与服务端用广播通信，基于UDP；

提供即插即用联网的机制，主机从服务器动态的获取**IP地址、子网掩码、默认网关、DNS服务器名称与其IP地址**

### RIP

RIP是一种**分布式的基于距离向量**的路由选择协议，是互联网的协议标志，最大的优点是简单

RIP协议要求网络中的每个路由器都维护一个自己到其他目的网络的唯一最佳距离记录(即一组距离)

距离：通常是跳数，即源端口到目的端口经过的路由器个数，**经过一个路由器跳数+1**。特别的，从路由器到直接相邻的网络距离为1.RIP允许一条路由最多经过15个路由器，**即跳数为16表示网络不可达**

**RIP只适用于小网络**

1. 和哪些路由器交换信息：相邻路由器
2. 交换什么信息：路由表
3. 在什么时候交换信息：30s一次，根据新信息更新路由表；超过180s没收到邻居路由器的消息则默认邻居没了并更新自己的路由表

### BGP

**BGP是应用层协议，使用TCP传输；使用TCP原因：安全，路由简化**

和谁交换：与**其他自治系统的邻站BGP发言人发送信息**

- BGP发言人：BGP邻界路由器
- 几个发言人用网络连接在一起

交换什么：交换网络可达性的信息，即要到达某个网络要经过的一系列自治系统

多久交换：当网络可达性发生变换的时候

# TCP/IP模型各层总结

|            | 基本数据单位 |                           主要任务                           |                             功能                             |               主要协议               |     什么到什么     |      设备      |
| :--------: | :----------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------: | :----------------: | :------------: |
|   应用层   |     报文     |                     提供系统与用户的接口                     |              文件传输、访问和管理、电子邮件服务              |      HTTP、SMTP、POP3、FTP、DNS      |     用户到用户     |                |
|   传输层   |    报文段    |               负责主机中**两个进程之间**的通信               | 1.为端到端连接提供**可靠的传输服务**；2.为端到端连接提供**流量控制、差错控制、服务质量**等管理服务 |               TCP、UDP               | 端到端(进程对进程) |                |
|   网络层   |    数据报    | 1.将传输层传下来的报文段**封装成分组**；2.选择适当的路由，**使传输层传下来的分组能够交付到目的主机** |   1.为传输层提供服务；2.组包和拆包；3.路由选择；4.拥塞控制   | IP、IPX、ICMP、IGMP、ARP、RARP、OSPF |     主机到主机     |     路由器     |
| 数据链路层 |      帧      |             **将网络层传下来的IP数据报组成成帧**             |  1.链路连接的建立、拆除、分离；2.帧定界和帧同步；3.差错检测  |              PPP、HDLC               |       点到点       |  网桥、交换机  |
|   物理层   |     比特     |                     实现比特流的透明传输                     |                 为数据端设备提供传送数据通信                 |                                      |                    | 集线器、中继器 |

# 一些重要地址

## MAC地址

### MAC地址

在局域网中，物理地址也叫硬件地址或MAC地址，该地址全球唯一，用于分辨设备

MAC地址有48位，常用16位16进制数表示，前24位标识厂商后24位由厂商分配

### 以太网MAC帧(商用)

![image-20220814194043938](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220814194043938.png)

- 前导码 8B

	前7B用来同步，后1B用来标志帧开始定界符

	**有开始定界符无结束定界符原因**：以太网使用曼彻斯特编码，若发送结束则信道一定没有变化，此时很方便就可以发现，且帧与帧之间存在最小间隔

- 目的地址 6B(48位MAC地址=48/8B=6B)

	目的地址共有三种情况，单播地址(目的主机MAC地址)、广播地址(全F)、多播地址

- 源地址 6B

- 类型 2B

	标识上层使用的网络协议

- 数据 46B-1500B
	$$
	\begin{aligned}
	& \because 以太网帧大小最小为64B \\
	& \therefore min=64-6-6-2-4=46B
	\end{aligned}
	\tag{1}
	$$
	最大帧长为1500B

- FCS 循环冗余检验余数

	循环冗余检验除数有国际规定

### 商用帧与IEEE 802.3协议帧的区别

1. 第三个部分为类型/长度
2. 当类型/长度字段值小于0x600时，数据字段必须装入LLC子层(存在丢失风险)

## IPv4地址

![image-20220820194701782](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220820194701782.png)

1. 版本

	IPv4/IPv6，常用值为4，长度为4bit

2. 首部长度

	长度为4bit，最大可表示值为15，每1bit表示首部有4B=32位

	故首部长度最大值为60B，所以固定首部20B，可变首部40B；最小值为5，常用值也是5

	填充字段将首部字段填充为4B的整数倍

3. 区分服务

	长度为8bit，期待哪种类型的服务，有用时才用

4. 总长度

	长度为16bit，表示IP数据报长度，每1bit表示IP数据报有1B

	故最大为$2^{16}-1$B，以太网MYU为1500B

5. 标识

	长度为16bit，一个计数器，每产生一个数据报就加1，并复制给标识字段，但其不是序号(因为IP是无连接服务)，故当一个数据报长度超过MTU时必须分片，且每个数据报分片都复制一次标识号

6. 标志

	长度为3bit，**标志中间一位为DF，只有DF=0时允许分片；标志中间一位为MF，MF=1表示后面还有分片，MF=0表示为分组最后一个分片**

7. 片偏移

	长度为13位，表示较长报文在分组后某片在原分组中的位置

	基本单位为8B，即每1bit表示8B的长度，同时表明**除了最后一个分组，分组长度一定为8B整数倍**

8. 生存时间(TTL)

	长度为8位，表示IP分组保质期

	每经过一个路由器生存时间减1，变为0时则表示其失效

9. 协议

	长度为8位，表示此分组数据报数据部分使用什么协议

	值为6则为TCP，值为17则为UDP，值为41则为IPv6

10. 首部校验和

	长度为16位，只检验首部，使用二进制求和检验

11. 源地址字段

	IPv4地址，32位，发送方IP地址

12. 目的地址字段

	IPv4地址，32位，接收方IP地址

## IPv6

### IPv6主要特点

解决IPv4地址不够的三种方式：**CIDR、NAT、IPv6(根本解决)**

主要特点是：

1. 改进首部格式

	可以快速处理/处理数据

2. 支持QoS—服务指令

	一种安全机制，用来解决网络延迟和阻塞的一种技术

### IPv6地址

#### 数据报格式

![image-20220825193625119](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825193625119.png)

- IPv6首部固定40B，可选扩展首部，算入有效载荷
- 下一个首部在固定首部和扩展首部都存在

#### 与IPv4区别

1. IPv6将地址**从32位(4B)扩展到128位(16B)**，更大的地址空间
2. IPv6将IPv4的**校验和字段移除**，以减少每跳的处理时间
3. IPv6将IPv4的可选字段移除首部，变成了**扩展首部**，成为了灵活的首部格式，路**由器通常不对扩展首部进行检查**，大大提高了路由的处理效率
4. IPv6支持即插即用(即自动配置)，不需要DHCP协议
5. IPv6首部长度必须是**8B的整数倍**，IPv4是**4B的整数倍**
6. **IPv6只能在主机处分片，IPv4可以在路由器和主机处分片**
7. ICMPv6：附加报文类型“分组过大”
8. IPv6支持资源的预分配，支持实时视像等要求，保证一定的带块和时延的应用
9. IPv6取消了协议字段，改成下一个首部字段
10. IPv6取消了总长度字段，改用有效载荷长度
11. IPv6取消了服务类型字段

#### 地址表示形式

冒号16进制记法，如*4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170*

压缩：连续的0只记一个，如*4BF5:0:0:BA5F:391:A:2176*

零压缩：一连串连续的0用一对冒号取代，只能用一次

#### 基本地址类型

- 单播：一对一通信，可做源地址+目的地址
- 多播：一对多通信，可做目的地址
- 任播：一对多中的一个通信，可做目的地址；一般是距离最近的一个

#### IPv4过渡策略

![image-20220825195327991](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825195327991.png)

## 端口号

**端口：长度为16bit，能表示65536个端口**

按范围分为

![image-20220831192234367](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220831192234367.png)

#### 套接字

在网络中利用发送方和接受方的套接字组合来识别端口，**套接字唯一标识了网络上的一个主机及其进程**
$$
Socket=(主机IP地址,端口号)
\tag{1}
$$

# 一些重要设备

## 网络层

### 路由器

![image-20220830193938194](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220830193938194.png)

> Why收到RIP/OSPF分组需要送到路由选择处理机，而数据分组不需要？
>
> - 因为RIP/OSPF分组一般包含更新的路由信息，需要据此对路由表进行更新，故需要送到路由选择处理机

#### 输入端口

![image-20220830194149160](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220830194149160.png)

#### 输出端口

![image-20220830194258166](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220830194258166.png)

也因此路由器的输入和输出队列是分组丢失的重要原因

#### 三层设备区别

路由器：能够互联两个网络层协议不同的网段

网桥：能够互联两个物理层和链路不同的网段

集线器：不能互联两个物理层不同的网段

|    作用范围    | 冲突域 | 广播域 |
| :------------: | :----: | :----: |
|   物理层设备   |   ×    |   ×    |
| 数据链路层设备 |   √    |   ×    |
|   网络层设备   |   √    |   √    |

冲突域：同一冲突域中，每个节点都能收到被发送的数据帧；同一时间只能有一台设备发送信息的范围

广播域：网络中能收到任何一台设备发出的广播帧的设备的集合；某站点发出一个广播信号，所有能接受这个信号的设备范围

#### 路由表与路由转发

![image-20220830194551779](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220830194551779.png)

## 链路层

物理层通过光纤与集线器扩展以太网，而链路层通过网桥和交换机扩展以太网

### 网桥

#### 概念

一般连接两个端点，根据MAC帧目的地址对帧进行转发和过滤，当网桥收到一个帧时并不直接转发，而是先检查帧的目的MAC地址，再确定将该帧转发到哪一个接口，或将其丢弃(即过滤)

**网段**：一般指计算机网络中使用同一物理层设备能直接通信的那一部分

#### 优点

- 过滤通信量，增大吞吐率

	以前一个网段10Mb，连上两个网桥分割成三个网段就有了30Mb

- 扩大了物理范围

- 提高了可靠性

	要错也就影响一个网段

- 可以互联不同物理层、不同MAC子层和不同速率的以太网

#### 分类

1. 透明网桥

	以太网站点不知道发送的帧要经过哪几个网络，即插即用

	流程如下：

	- 网桥检查帧的源地址，若转发表中没有则记录源地址及其接收接口
	- 网桥检查目的地址，若转发表中有则按其接收地址转发，若没有则向所有接口转发(除了发过来的结口)；若检测发现目的地址与源地址在同一网段则不转发

	![image-20220816194728750](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220816194728750.png)

2. 源路由网桥

	在发送帧时，将详细的最佳路由信息(路由最少/耗时最短)放在首部

	方法：源站以广播形式向目的站发送发现帧，响应多种方案，往回发时新建一个帧放在首部

### 交换机—多接口网桥

![image-20220816195021802](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220816195021802.png)

可分为

1. 直通式交换机

	查完目的MAC地址就直接发送

	延迟小、可靠性低，无法支持具有不同速率的端口的交换

2. **存储转发式交换机**–常用

	将帧放入高速缓存中，检查帧是否正确，正确就转发，错误就丢弃

	延迟大、可靠性高，可以支持具有不同速率的端口的交换

## 物理层

### 中继器

功能：对信号进行再生和复制，对衰减的信号进行放大，保持与原数据相同，以增加信号传输距离，延长网络长度；==放大数字信号，仅作用于信号的电气特性==

> 使用双绞线传输数字信号时，使用中继器对其进行放大
>
> 使用双绞线传输模拟信号时，使用放大器对其进行放大

通信双方：中继器有两端，且两端的网络部分是网段，不是子网

- 适用于完全相同的网端的互连，且两个网段的速率要完全一致
- 只将任何电缆上的数据发送到另一端上，仅作用于信号的电气特性，并不管数据中是否有错误数据或不适用于网段的数据

> 两端可连相同媒体，或不同媒体(有线连有线，有线连无线)

5-4-3规则(10BASE5)：互相串联的**中继器个数不能超过4个**，而且用4个中继器串联的**5段通信介质**中只有**3段可以连计算机**，其余用来扩展通信范围的链路端。

### 集线器(多口集线器)

功能：还是对信号进行放大转发

> 不具备信号的定向传递能力，是一个共享设备

常用在星型拓扑中，信号可能冲突

## 总结

|    作用范围    | 冲突域 | 广播域 |
| :------------: | :----: | :----: |
|   物理层设备   |   ×    |   ×    |
| 数据链路层设备 |   √    |   ×    |
|   网络层设备   |   √    |   √    |

冲突域：同一冲突域中，每个节点都能收到被发送的数据帧；同一时间只能有一台设备发送信息的范围

广播域：网络中能收到任何一台设备发出的广播帧的设备的集合；某站点发出一个广播信号，所有能接受这个信号的设备范围

# 一些重要数据结构

1. **虚电路表**

  用来维持虚电路

  每一块都记录一个打开的虚电路的信息

2. **转发表(网桥&交换机)**

	数据项为地址和接口

	故特点是登记帧的来源，转发表有则按着发，没有则广播

	> 若转发表为空，则帧处理方法与转发表建立方法如下：
	>
	> 1. 从端口x收到无差错的帧，在转发表中找目的站MAC地址
	> 2. 若有，则查找出此MAC地址应当走的端口d，然后进行3，否则转到5
	> 3. 若到这个MAC地址去的端口等于x(d=x)，则丢弃此帧，否则从端口d转发
	> 4. 转到6
	> 5. 向网桥除了x以外的所有端口转发此帧
	> 6. 若源站不在转发表中，则将源站MAC地址加到转发表中，登记此帧进入网桥的端口号，设置计时器，转到8；如果源站在转发表中，执行7
	> 7. 更新计时器
	> 8. 等待新的数据帧

3. **NAT转换表**

	|  WAN段(广域网)  |              LAN段(局域网)               |
	| :-------------: | :--------------------------------------: |
	| 外部IP：端口号1 | 私有IP1：端口号1(端口号唯一标识一个进程) |
	| 外部IP：端口号2 |              私有IP2：端口2              |
	|       ……        |                    ……                    |

4. **路由表(路由器)**

	**路由表有目的网络地址、目的网络子网掩码、下一跳地址**

5. **路由表(BGP)**

	**BGP支持CIDR**，故BGP的路由表包括目的网络前缀，下一跳路由器，以及到达目的网络要经过的各个自治系统序列

6. **ARP表**

	各主机/路由器都有**ARP缓存(IP与MAC地址的映射)**，用来存放本局域网上各主机和路由器的IP地址到MAC地址得到映射表，称为**ARP表**。**使用ARP协议来维护ARP表**

# 一些帧格式

## 数据链路层

主要有四种

- 普通数据帧
- 以太网MAC帧
- PPP帧
- HDLC帧

由于书中对普通数据帧介绍较少，故此处不具体展开

### 以太网MAC帧

#### 以太网MAC帧(商用)

![image-20220814194043938](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220814194043938.png)

- 前导码 8B

	前7B用来同步，后1B用来标志帧开始定界符

	**有开始定界符无结束定界符原因**：以太网使用曼彻斯特编码，若发送结束则信道一定没有变化，此时很方便就可以发现，且帧与帧之间存在最小间隔

- 目的地址 6B(48位MAC地址=48/8B=6B)

	目的地址共有三种情况，单播地址(目的主机MAC地址)、广播地址(全F)、多播地址

- 源地址 6B

- 类型 2B

	标识上层使用的网络协议

- 数据 46B-1500B
	$$
	\begin{aligned}
	& \because 以太网帧大小最小为64B \\
	& \therefore min=64-6-6-2-4=46B
	\end{aligned}
	\tag{1}
	$$
	最大帧长为1500B

- FCS 循环冗余检验余数

	循环冗余检验除数有国际规定

#### 商用帧与IEEE 802.3协议帧的区别

1. 第三个部分为类型/长度
2. 当类型/长度字段值小于0x600时，数据字段必须装入LLC子层(存在丢失风险)

### PPP帧

点对点，使用字符，使用最广泛(拨号上网)，**只支持全双工链路**，**面向串行链路**

**要求**

1. 简单：对链路层帧无纠错，无序号，无流量控制
2. 封装成帧
3. 透明传输：处理帧中非法字符，如同步线路使用比特填充法、异步线路使用字节填充法
4. 多种网络层协议：对上次IP协议无所谓
5. 多种类型链路：连接的链路类型无所谓
6. 差错检测：使用CRC循环冗余检验，若错就丢弃
7. 检测链路连接状态：链路是否正常工作
8. 最大数据传输单元：MTU$\le$1500
9. 网络层地址协商：让双方确认对方网络层地址
10. 数据压缩协商

PPP协议**无需**纠错、流量控制、不进行编号、不支持多点通信

![image-20220815195913110](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815195913110.png)

- F：7E为16进制，即01111110，一个填充字段
- A：地址字段，固定为11111111
- C：控制字段，固定为00000011
- 协议：表示信息部分是什么，到底是IP数据报还是LCP数据还是网络控制数据
- IP数据报中的转义字符为TD=01111101
- FCS：CRC循环冗余检验余数
- F：同第一个字段，为字符填充字段

### HDLC帧

点对点，**面向比特**，不属于TCP/IP协议组，由ISO制定；**可透明传输，0比特插入法**，易硬件实现；**使用全双工通信**；所有帧都采用CRC检验，对信息帧进行顺序编号，可防止漏传或重发，传输可靠性高

**帧格式**

![image-20220816192549941](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220816192549941.png)

- 标志F 8位：标志帧开始

- 地址A 8位：可用从站或应答站的地址

- 控制C 8位：

	信息帧：第一位为0，用来传输数据信息，或使用捎带技术对数据进行确认

	监督帧：10，用于流量控制和差错控制，执行对信息帧的确认、请求重发或请求暂停发送等

	无编号帧：11，用于提供对链路的建立、拆除等多种控制功能

- 注意在透明传输区间使用了0比特插入法，即5个连续的1插入一个0

### PPP协议与HDLC协议异同点

相同点

- 两者都全双工

- 两者都实现了透明传输

	PPP在异步传输时使用字符填充，同步时使用比特填充；HDLC使用0比特填充法

- 都使用CRC进行差错检验，但其不会纠正

不同点

| PPP协议  | 面向字符 | 帧中有2B协议字段 | 帧无编号 | 不可靠 |
| -------- | -------- | ---------------- | -------- | ------ |
| HDLC协议 | 面向比特 | 无               | 帧有编号 | 可靠   |

## 网络层

### IPv4

#### IPv4分组的格式

![image-20220820194544796](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220820194544796.png)

具体格式如下：

![image-20220820194701782](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220820194701782.png)

1. 版本

	IPv4/IPv6，常用值为4，长度为4bit

2. 首部长度

	长度为4bit，最大可表示值为15，每1bit表示首部有4B=32位

	故首部长度最大值为60B，所以固定首部20B，可变首部40B；最小值为5，常用值也是5

	填充字段将首部字段填充为4B的整数倍

3. 区分服务

	长度为8bit，期待哪种类型的服务，有用时才用

4. 总长度

	长度为16bit，表示IP数据报长度，每1bit表示IP数据报有1B

	故最大为$2^{16}-1$B，以太网MTU为1500B

5. 标识

	长度为16bit，一个计数器，每产生一个数据报就加1，并复制给标识字段，但其不是序号(因为IP是无连接服务)，故当一个数据报长度超过MTU时必须分片，且每个数据报分片都复制一次标识号

6. 标志

	长度为3bit，==**标志中间一位为DF，只有DF=0时允许分片；标志最后一位为MF，MF=1表示后面还有分片，MF=0表示为分组最后一个分片**==

7. 片偏移

	长度为13位，表示较长报文在分组后某片在原分组中的位置

	基本单位为8B，即每1bit表示8B的长度，同时表明**除了最后一个分组，分组长度一定为8B整数倍**

8. 生存时间(TTL)

	长度为8位，表示IP分组保质期

	每经过一个路由器生存时间减1，变为0时则表示其失效

9. 协议

	长度为8位，表示此分组数据报数据部分使用什么协议

	值为6则为TCP，值为17则为UDP，值为41则为IPv6

10. 首部校验和

	长度为16位，只检验首部，使用二进制求和检验

11. 源地址字段

	IPv4地址，32位，发送方IP地址

12. 目的地址字段

	IPv4地址，32位，接收方IP地址

> IP数据报一般前12B为控制字段，之后的8B分别为源地址4B和目的地址4B

#### IP数据报分组

MTU为链路层数据帧最大数据量，一般以太网的MTU为1500B，许多广域网MTU$\le$576B

当IP数据报长度大于MTU时就需要分片(DF=0)，若DF=1则不能分，需要返回ICMP控制报文

1. 标识：同一数据报的分片标识都一样，长度为16位

2. 标志：只有两位有意义，长度为3位；

	- DF=1：不分片
	- DF=0
		- MF=1：后面还有分片
		- MF=0：最后一个分片

3. 片偏移：片在数据报中的哪一个位置，长度为13位，单位为8B

	**除了最后一个分组，分组长度一定为8B整数倍**

> ![image-20220822193517621](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220822193517621.png)

> 总长度：16位，单位为1B
>
> 首部长度：4位，单位为4B
>
> 片偏移：13位，单位为8B

#### ICMP(网际控制报文协议)

**ICMP是一个网络层协议**，在网络层和传输层之间交换信息(更有效地转发IP数据报和提高交付机会)

支持主机/路由器；有差错报告；有网络探询

##### 报文格式

![image-20220825191536676](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825191536676.png)

- 类型：哪种ICMP报文
- 代码：细分
- 校验和：校验整个ICMP首部

> ICMP差错报告报文格式
>
> ![image-20220825192403362](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825192403362.png)

### IPv6

#### IPv6主要特点

解决IPv4地址不够的三种方式：**CIDR、NAT、IPv6(根本解决)**

主要特点是：

1. 改进首部格式

	可以快速处理/处理数据

2. 支持QoS—服务指令

	一种安全机制，用来解决网络延迟和阻塞的一种技术

#### IPv6地址

##### 数据报格式

![image-20220825193625119](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825193625119.png)

- IPv6首部固定40B，可选扩展首部，算入有效载荷
- 下一个首部在固定首部和扩展首部都存在

##### 与IPv4区别

1. IPv6将地址**从32位(4B)扩展到128位(16B)**，更大的地址空间
2. IPv6将IPv4的**校验和字段移除**，以减少每跳的处理时间
3. IPv6将IPv4的可选字段移除首部，变成了**扩展首部**，成为了灵活的首部格式，路**由器通常不对扩展首部进行检查**，大大提高了路由的处理效率
4. IPv6支持即插即用(即自动配置)，不需要DHCP协议
5. IPv6首部长度必须是**8B的整数倍**，IPv4是**4B的整数倍**
6. **IPv6只能在主机处分片，IPv4可以在路由器和主机处分片**
7. ICMPv6：附加报文类型“分组过大”
8. IPv6支持资源的预分配，支持实时视像等要求，保证一定的带块和时延的应用
9. IPv6取消了协议字段，改成下一个首部字段
10. IPv6取消了总长度字段，改用有效载荷长度
11. IPv6取消了服务类型字段

##### 地址表示形式

冒号16进制记法，如*4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170*

压缩：连续的0只记一个，如*4BF5:0:0:BA5F:391:A:2176*

零压缩：一连串连续的0用一对冒号取代，只能用一次

##### 基本地址类型

- 单播：一对一通信，可做源地址+目的地址
- 多播：一对多通信，可做目的地址
- 任播：一对多中的一个通信，可做目的地址；一般是距离最近的一个

# 物理层

## 通信基础

多为选择题，重点是==奈奎斯特定理和香农定理、编码与调制技术、数据交换方式，以及电路交换、报文交换与分组交换技术等==

### 基本概念

#### 数据通信相关术语

1. 数据

   传递信息的实体，通常是有意义的二进制序列

2. 数据通信

   在不同计算机之内传输表示信息的二进制序列的过程

3. 信号

   数据的电气/电磁表现，是**数据在信道上的存在形式**

   可分为：

   - 数字信号(离散信号)：代表信号的参数取值是离散的

   - 模拟信号(连续信号)：代表信号的参数取值是连续的

     ==发什么信号由信道决定，信道是离散的就发离散信号==

4. 信源

   信号源头

5. 信宿

   信号目的地

6. 信道

   信号的传输媒介；

   Note: 一般用来表示**向某一端传输信息的介质**，故**一条通信线路有一条发送信道和一条接受信道**

   分类：

   - 按传输信号分：**模拟信道(模拟信号)、数字信道(数字信号)**
   - 按传输介质分：无线信道(Wifi)、有线信道(双绞线)

#### 三种通信方式

1. 单工(你说我听)

   一方只能发，另一方只能收，故一条信道

2. 半双工(我一句你一句)

   双方都能收发，但同时只能一方发另一方收，两条信道

3. 全双工(一起说)

   双方可同时收发

#### 数据传输方式

1. 并行传输

   将表示一个字符的8位二进制数同时通过8条信道发送

   特点：速度快，费用高，适合近距离

   多用在计算机内部数据传输

   ```mermaid
   %%{init:{'theme':'base', 'themeVariables':{'fontSize':'8px'}}}%%
   graph LR
   A[发送方]--0-->B[接受方]
   A--其他字符-->B
   A--1-->B
   ```

   

2. 串行传输

   将表示一个字符的8位二进制数按位依次发送

   特点：速度慢，费用低，适合远距离

   ```mermaid
   graph LR
   A[发送方]--00001111-->B[接受方]
   ```

   

#### 同步 or 异步传输(实现字符同步方法)

1. 同步传输—**以帧(数据块)为单位**

   **数据的传输以一个数据区块为单位**，故也叫区块传输

   在传输数据时，**先发出1个或多个同步字符，再发数据**

2. 异步传输—**以字节为单位**

   **将比特拆分为小组传输，发送方可以在任意时刻发送，接收方不确定什么时候到达**

   在发送时数据加上起始位和结束位
   
   > 异步传输：一次传输一个字符(5~8位组成)，每个字符用一个起始符引导，同一个停止码结束，如果没有数据发送，发送方可以连续发送停止码

​	为什么实现字符同步？

​	需要知道数据的开头、内容、结尾等

#### 速率有关概念

1. 码元

   概念：是指**用一个固定时长的信号波形(数字脉冲)，代表不同离散数值的基本波形**

   码元是**数字通信中数字信号的计量单位**，这个时长内的信号称做k进制码元，而该**时长称为码元宽度**

   当码元的离散状态有M个时(M>2)，此时码元为M进制码元

   Note: **1码元可以携带多个比特的信息量**

   > 二进制码元只有0、1两种状态，故其信息量为1比特
   >
   > 四进制码元则有00、01、10、11四种状态，故其信息量为2比特
   >
   > $2^n$进制码元信号量便有$n$比特

2. 速率

   可分为码元传输速率和信息传输速率

   - 码元传输速率(波特率)

     **单位时间内数字通信系统所传输的码元个数(脉冲个数或信号变化次数)**，单位是波特 B

     码元传输速率与码元进制数无关，只与码元长度T(码元时长)有关

     $$R_B=\frac{1}{T}B$$

   - 信息传输速率

     **单位时间内数字通信系统所传输的码元所含信息数**，单位为比特/秒 b/s

   - 二者关系

     若一个码元携带$n$ bit的信息量，则$M$ B的码元传输速率对应的信息传输速率为$M*n$ bit/s

3. 带宽

   表示单位时间内**从网络的一点到另一点所能通过的最高数据率在一单位时间内通过链路的数量**，单位是bps（比特每秒）

### 奈奎斯特定理与香农定理

只有此处带宽为Hz

#### 失真

![image-20220726210614672](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220726210614672.png)

#### 奈氏准则(奈奎斯特定理)

限制码元极限传输速率

**在理想低通(无噪音 带宽受限)条件下，为了避免码间串扰，极限码元传输速率为$2W$Band，W为信道带宽(Hz)；故极限数据传输速率为$2Wlog_2V$b/s，V为码元进制数**

Note:

1. 在任何信道上，码元传输速率都有上限，否则会出现码间串扰
2. **信道的带宽越宽(能通过的信号频数越多)，就可以用更高的速率(W越大码元速率越大)进行码元的传输**
3. 奈式准则只限制了码元传输速率，没有限制数据传输速率
4. 由于码元传输速率受奈氏准则规约，故要提高数据传输速率，可以设法让码元携带更多的比特信息量，即提高码元进制数

#### 香农定理

**信噪比：用来衡量噪声对信号的影响**

$$信噪比=\frac{信号的平均速率}{噪声的平均速率}$$ 记为 $\frac{S}{N}$，并用分贝(dB)作为单位，即$信噪比(dB)=10log_{10}\frac{S}{N}$

香农定理

在带宽受限且有噪声的信道中，为了不产生误差，数据传输速率有上限值，一般**给定信噪比dB求$\frac{S}{N}$**
$$
信道的极限数据传输速率=W*log_2(1+\frac{S}{N}) \qquad (b/s)
\tag{1}
$$
Notes:

1. 信道的带宽或信道中**信噪比越大，极限数据传输速率越大**
2. 传输带宽与信噪比确定后，极限数据传输速率确定
3. **只要信息传输速率低于信道极限信息传输速率，总有方式让数据无差错传输**
4. 实际的信道传输速率远低于信道极限信息传输速率

> 若题中有信噪比，则奈氏准则和香农定理各求一次，取其数据传输速率最小值

### 编码与调制

#### 基带信号与宽带信号

信道上传输的信号的两种形式，与数字、模拟信号是两种分类方式

1. 基带信号：**将数字信号0、1用两种不同电压表示，再送到数字信道上传输**(基带传输)

	> 一般来说基带信号就是发出的直接表达要传输信息的信号
	>
	> 距离近

2. 宽带信号：将基带信号进行调制后形成的==频分复用模拟信号==，再传到==模拟信道==上进行传输(宽带传输)

	> 距离远

#### 编码与调制

编码：用在基带传输，规定0、1表示方法

调制：将基带信号转成宽带信号

![编码和调制](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E7%BC%96%E7%A0%81%E5%92%8C%E8%B0%83%E5%88%B6.png)

### 电路交换、报文交换与分组交换

![三种交换方式](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E4%B8%89%E7%A7%8D%E4%BA%A4%E6%8D%A2%E6%96%B9%E5%BC%8F.png)

#### 电路交换

原理：在数据传输期间，在源节点和目的节点之间建立一条由中间节点组成的==专用物理链路==，在数据传输结束前，该链路一直存在

阶段

```mermaid
graph LR
A[建立连接 呼叫或电话建立]-->B[通信 电路传输]-->c[释放连接 拆分电路]
```

特点

- 独占资源，在这条链路上用户始终占用
- 适用于远程批处理系统或对实时性要求很高的大量数据传输系统

优缺点

|                             优点                             |                             缺点                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|                          传输时延小                          |                        建立连接事件长                        |
|                   数据顺序到达，无失序问题                   | 线路独占，即使目前线路空闲，其他用户也无法使用，信道使用效率低 |
| 实时性强，双方一旦建立物理通路，便可以实时通信，适用于交互式会话类通话 | 灵活性差，双方连接通路中的任意一点宕机，便必须重新拨号建立新连接，不适应突发通信 |
| 全双工通信，没有冲突，通信双方有不同的信道，不会争用物理信道 |                无数据存储能力，难以平滑通信量                |
|                   适用于数字信号和模拟信号                   | 电路交换时，数据直达，不同类型、不同规格、不同速率的终端很难相互进行通信 |
|             控制简单，电路的交换设备及控制较简单             |     无法发现与纠正传输差错，难以在通信过程中进行差错管理     |

例子

![image-20220728193127989](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220728193127989.png)

#### 报文交换

报文：网络中交换与传输的数据单元，即站点一次性要发送的数据块；包含了将要发生的完整的数据信息，==其长短很不一致，长度不限且可变==

原理：无需在传输过程中建立物理链路，其数据传输单位为报文；使用存储转发技术

- 每个节点收下整个报文后，暂存报文并检查有无错误
- 当所需的输出链路空闲时，利用路由信息找到下一个节点地址，传输到下一个节点
- 在两个通信用户之间其他线路段可传输其他用户的报文，不独占

优缺点

|                             优点                             |                             缺点                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|       无需建立连接，无建立链接时延，用户可随时发送报文       | 实时性差，不适合传输实时或交互式业务的数据，数据进入交换节点后要经历存储转发过程，从而引起转发时延 |
|   动态分配线路，动态选择报文通过的最佳路径，可以平滑通信量   |                     ==只适用于数字信号==                     |
|          提高线路可靠性，某条链路宕机可选用其他线路          |                                                              |
|                  提高线路利用率，线路不独占                  |                                                              |
|           提供多目标服务，一个报文可到达多个目的地           |                                                              |
| 在存储转发中容易实现代码转换和速率匹配，甚至收发双方可以不同时处于可用状态，便于计算机通信 | 由于报文长度没有限制，而每个中间节点都要完整的接受传来的整个报文，当输出线路不空闲时，还可能要存储多个完整报文等待转发，要求网络中每个节点有较大的缓冲区，为了介绍成本，有时候要把等待转发的报文存在硬盘上，增大了传输时延 |

#### 分组交换

分组：将任意长度的报文划分为等长的小块，然后成块的发送

原理：与报文传输基本类似，只是将传输单元从任意长的报文改为固定长的分组

- 分组一般长为**128B**，以分组为单位进行传输和接收
- 发送节点将数据划分为一定长度的分组，接受节点将报文组装后发送给上层
- 分组=小数据块+控制信息(源地址+目的地址+分组序号)

优缺点

|                             优点                             |                             缺点                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|       无需建立连接，无建立链接时延，用户可随时发送分组       | 比报文传输好一点，但还有存储转发时延，且结点交换机处理能力要求更强 |
|                         线路利用率高                         | 每个分组都要加控制信息，一定程度上降低了通信效率，增加了处理事件 |
|               简化了存储管理，因为分组长度固定               |                                                              |
| 加速存储，后一个分组的存储可以和前一个分组的转发并发操作；传输一个分组比一个报文所需缓冲区小 |                                                              |
|      减少出错几率和重发数据量，提高可靠性，减少传输时延      |                                                              |
|                   分组短小，适用于突发通信                   | 当**分组交换使用数据报传输**时，可能出现失序、丢失或重复分组，分组到达目的地时要对分组排序；若**使用虚电路传输**，虽无失序问题，但有呼叫建立、数据传输、释放虚电路三个阶段 |

#### 数据传输方式选择

- **传输数据量大，且传送事件远大于呼叫时间，采用电路交换**(电路时延最小)
- 端到端的通路有很多段的链路组成，采用分组交换
- 从信道利用率上来看，==**报文交换与分组交换优于电路交换，其中分组交换更优，尤其适合于计算机之间的突发通信**==
- ![image-20220728195213802](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220728195213802.png)

### 数据报传输和虚电路传输

#### 数据报传输

传输过程

> ![image-20220728195525016](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220728195525016.png)

1. 源主机(A)将报文分成多个分组，依次发送到直接相邻的结点A

2. 结点A对每个分组进行**差错检验和路由选择**，不同分组的下一站可能不同

3. 结点C收到$P_1$后，对$P_1$进行差错检验(其他结点同理)

	若正确则对A发确认信息，A收到确认后丢弃A副本

	若错误则让A重发

4. 分组到达B

特点

1. 用发送方提供**无连接服务**，发送方可随时发送，接收方可随时接收
2. 同一报文的不同分组到达目的结点时**可能失序、重复或丢失**
3. 每个分组都有**源+目的地址+分组序号**
4. 分组在存储转发时，需要排队等候，会带来排队时延。当通过交换结点的通信量较大或网络发送拥堵时，这种时延会大大增加，交换结点还可能会丢弃一些分组
5. **网络存在冗余路径，适用于突发性通信、不适用于长报文、会话式通信**

#### 虚电路传输

> 传输过程
>
> ![image-20220729194525853](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220729194525853.png)

**存在永久虚电路(PVC)和零食虚电路(SVC)两种**

将数据包和电路交换形式相结合

虚电路：一条源主机到目的主机的类似于电路的**逻辑路径**；路径中所有结点都需要维持这条虚电路的建立，都维持一张**虚电路表(具体见上)**

特点

1. 提供连接服务，源节点与目的节点之间建立逻辑连接
2. 一个通信的所有分组都通过虚电路顺序发送，==**分组不携带源地址、目的地址等信息，但包括虚电路号**==；相对数据报方式开销小，同一报文的不同分组到达目的节点**不会失序、重复或丢失**
3. 分组通过虚电路上每个节点时，**进行差错检验**不进行路由选择
4. **每个节点可能和多个节点之间建立多条虚电路**，每条虚电路支持特点的两个系统之间的数据报传输，可以对两个数据端点的流量进行控制，**两个端系统之间也可能有多条虚电路，为不同进程服务**。
5. 缺点是：当网络中的某个节点或链路宕机时，所有经过该节点或链路的虚电路都被破坏

#### 二者对比

|                    |                         数据报服务                         |                        虚电路服务                        |
| :----------------: | :--------------------------------------------------------: | :------------------------------------------------------: |
|     连接的建立     |                           不需要                           |                           需要                           |
|      目的地址      |                   每个分组都携带目标地址                   |           不需要携带目标地址，只需要带虚电路号           |
|      路由选择      |               在每个通信节点都要进行路由选择               | 不需要，链路建立时便已经路由选择好了，其他时候直接发就OK |
|      分组顺序      |                         不保证顺序                         |                          不失序                          |
|       可靠性       |                  不可靠，可靠性由用户保证                  |                     可靠性由网络保证                     |
| 对网络故障的适应性 | 出故障的节点丢失分组，其他分组路径选择发送变化，可正常传输 |          所有经过故障节点的虚电路均不能正常工作          |
| 差错处理和流量控制 |            由用户主句保证流量控制，不保证可靠性            |              可以由网络负责，可也由用户负责              |

#### ==三种交换时延计算方法==

1. 四种时延
	$$
	发送时延(传播时延)=\frac{数据块长度(bit)}{数据率(b/s)} \\
	传输时延=\frac{链路长度(m)}{传播速度(m/s)} \\
	处理时延=节点存储转发所用时间 \\
	排队时延=节点排队时间
	\tag{1}
	$$
	1在发送器中，2在链路上，34在节点中
	
2. 电路交换
	$$
	时延=建立连接时延+传输时延+传播时延 \quad (没有存储转发)
	\tag{2}
	$$
	
3. 报文交换
	$$
	发送时延(传播时延)=\frac{数据块长度(bit)}{数据率(b/s)}*链路数 \\
	传输时延=\frac{链路长度(m)}{传播速度(m/s)}*链路数 \\
	处理时延=节点存储转发所用时间=单个节点处理时延*节点数 \\
	排队时延=节点排队时间=单个节点排队时延*节点数
	\tag{3}
	$$
	
4. 分组交换
	$$
	发送时延(传播时延)=\frac{总分组长度(bit)}{单个分组数据长度(bit)}*\frac{单个分组长度(bit)}{数据率(b/s)}+节点数*\frac{单个分组长度(bit)}{数据率(b/s)} \\
	传输时延=\frac{链路长度(m)}{传播速度(m/s)} \\
	处理时延=最后一个节点的排队时延 \\
	排队时延=一个分组的排队时延
	\tag{4}
	$$

## 传输介质

### 双绞线、同轴电缆、光纤和无线传输介质

传输介质(传输媒体/传输媒介)：数据传输过程中在发送设备和接受设备之间的**物理通路**

> Note：不是物理层，可看作第0层
>
> 分类：
>
> - **导向性**传输介质：电磁波导向沿着固体媒介传输
> - **非导向性**传输介质：自由传输

#### 双绞线(常用)

概念：由两根采用**一定规则并排绞合的，相互绝缘的铜导线**组成

分类：绞合可以减少对相异导线的电磁干扰

![image-20220729195325918](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220729195325918.png)

> **双绞线价格便宜，是最常用的传输介质之一**，在局域网和传统电话网中普通使用。模拟传揄和数字传输都可以使用双绞线，其通信距离一般为几公里到数十公里。距离太远时，对于**模拟传输**，要用**放大器**放大衰减的信号：对于**数字传输**，要用**中继器**将失真的信号整形

#### 同轴电缆

> ![image-20220729200141960](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220729200141960.png)

#### 光纤

> ![image-20220729200159410](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220729200159410.png)
>
> ![image-20220729200214910](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220729200214910.png)

#### 无线传播介质

> ![image-20220729200230559](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220729200230559.png)

### 物理层接口特性

> ![image-20220729200335844](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220729200335844.png)

## 物理层设备

见上

# 数据链路层

重点掌握==滑动窗口机制、三种可靠传输协议、各种MAC协议，HDLC协议和PPP协议，特别是**CSMA/CD协议和以太网帧格式，以及局域网的争用期和最小帧长的概念、二进制指数退避算法**==。此外，==中继器、网卡、集线器、网桥和局域网交换机的原理及区别==也要重点掌握

## 数据链路层的功能

### 概述

定义

- 结点：主机、路由器
- 链路：两结点之间的物理通路，传输介质主要为有线(双绞线、同轴电缆)或无线
- 数据链路：两结点之间的逻辑通路，把实现控制数据传输协议的硬件和软件加到链路上便是数据链路
- 帧：数据链路层传输的最小单位，封装网络层数据报

作用：数据链路层负责通过一条链路向另一个物理链路直接相连的相邻结点传输数据

> ![image-20220731194518687](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220731194518687.png)

功能

1. 为网络层提供服务

	> 三种服务：
	>
	> - 无确认无连接的服务：实时传输，误码率低
	> - 有确认无连接的服务：收到消息确认，超时重传，使用无线传输时误码率高
	> - 有确认有连接的服务：安全可靠

2. 建立、维持、销毁链路

3. 组帧

4. 流量控制：发送方少发

5. 差错控制：帧错或位错

## 封装成帧和透明传输

### 封装成帧

主要指在帧前后加上帧首部和帧尾部，组成帧

> 接收端在收到帧后，就可以通过帧首部和帧尾部(包含很多控制信息，其中帧定界符用来确定帧的界限)来从数据流中取出帧

**帧同步：指接收方应当能从比特流中区分帧的起始和结束**

组帧的方法

- ![image-20220731195429306](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220731195429306.png)

### 透明传输

指不管所传数据是什么样的比特流，都应当能在链路上传输

### 组帧方法

#### 字符计数法

帧首部用一个**计数手段**(第一个字节)表示帧内字符数(**包括首部**)

cons：若首部出错则后面所有帧都出错

#### 字符(节)填充法

在帧首部、帧尾部分别插入SOH(start of header)、EOT(end of transmission)，两个标识元素均为一个字符大小 

1. 当帧传输文本文件(键盘输入)时，十分简单直接插入标识元素即可

2. 当帧传输非ASCII码的文件时，就要采用字符填充法

	文件数据中可能会出现与SOH、EOT、ESC相同的字符，使用转义字符(ESC)来解决问题

> ![image-20220801192034650](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220801192034650.png)

#### 零比特填充法

允许数据帧中包含任意个数的比特，首尾标识符一样为01111110

保证了透明传输；在传送的比特流中可以传输任意的比特组合而不会引起帧边界的判断错误

> ![image-20220801192911846](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220801192911846.png)

#### 违规编码法

物理层进行比特编码时常用违规编码法，如曼彻斯特编码使用“高-低”表示1、“低-高”表示0，此时“高-高”和“低-低”在数据比特中便是违规的，使用这两个信号就可用来做定界帧的起始和终止。

**现在常用比特填充法和违规编码法**

## 差错控制

![差错](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E5%B7%AE%E9%94%99-16593538419162.png)

### 检错编码

**检错编码都使用了冗余编码技术**

> 冗余编码：在数据发送前，先按一定规律附加上冗余位，构成一个符合某一规则的码字后发送。在发送的数据变化时冗余位也会相应的变化，接收方按照收到的码字是否遵循原规则，从而判断是否出错

#### 奇偶校验码

![奇偶校验码](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E5%A5%87%E5%81%B6%E6%A0%A1%E9%AA%8C%E7%A0%81.png)

检验出错能力差，若信息有偶数位变化就检验不出来了

#### 循环冗余码

![image-20220801194550057](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220801194550057.png)

> 若要发送的数据是1101 0110 11，使用CRC校验，生成多项式为10011，那要发送的数据是
>
> ![image-20220801195414108](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220801195414108.png)
>
> 接收方验证过程如下：
>
> ![image-20220801195843238](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220801195843238.png)

**FCS生成以及接受端CRC校验都由硬件实现**，处理迅速，不会延误数据传输；但==数据链路层仅仅使用循环冗余检验CRC差错检测技术只能做到对帧的无差错接受，而出错的帧将直接丢弃，故还达不到可靠传输(发什么就收什么)==

### 纠错编码(海明码)

$确认校验码位数r \to 确认校验码和数据的位置 \to 求出校验码的值 \to 检错并纠错$

#### 海明距离(码距)

两个合法编码(码字)的对应比特取值不同的比特数即为==两个码字的海明距离(码距)==

一个有效编码集中，任意两个合法编码的海明距离的最小值称为==该编码集的海明距离(码距)==

> 编码系统：000、001、010、011、100、101、110、110码距为1
>
> 编码系统：0000、1001、1010、0011、1100、0101、0110、1111码距为2

**检测$\alpha$位错误需要$\alpha+1$个校验值，纠错$\alpha$位错误需要$2\alpha+1$个校验值**

#### 纠错过程

以数据为1010举例

1. 确定校验码位数$r$

	数据/信息有m位，冗余码/校验码有r位，故校验码有$2^r$个取值，为了检错$\alpha$位错误需要$\alpha+1$个校验值，所以为了检错$m+r$位错误需要$m+r+1$个校验值，故$2^r \ge m+r+1$

	对1010来说$m=4, \quad r=3$，设信息位为$D_4D_3D_2D_1(1010)$，校验位为$P_3P_2P_1$，海明码就为$H_7H_6H_5H_4H_3H_2H_1$

2. 确定校验码和数据位的分布

	校验码应位于$2^i$位

	|  H_7   |  H_6   |  H_5   | H_4  |  H_3   | H_2  | H_1  |
	| :----: | :----: | :----: | :--: | :----: | :--: | :--: |
	| D_4(1) | D_3(0) | D_2(1) | P_3  | D_1(0) | P_2  | P_1  |

3. 求出校验码的值

	 **被校验数据位的海明位号等于校验该数据位的各校验位海明位号之和，校验位不需要被校验**

	![image-20220802193256668](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220802193256668.png)

	检验位$P_i$的值为第i组(由该校验位校验的数据位)所有位求异或
	$$
	P_1=D_1 \oplus D_2 \oplus D_4 =0 \oplus 1 \oplus 1 = 0 \\
	  P_2=D_1 \oplus D_3 \oplus D_4 =0 \oplus 0 \oplus 1 = 1 \\
	  P_3=D_2 \oplus D_3 \oplus D_4 =1 \oplus 0 \oplus 1 = 0 \\
	  \tag{1}
	$$

​		故海明码为$H_7H_6H_5H_4H_3H_2H_1=1010010$

4. 检错并纠错

  每个校验组分别利用检验位和参与形成该校验位的信息位进行奇偶校验检查，形成k个校验方程
$$
  S_1=P_1 \oplus D_1 \oplus D_2 \oplus D_4 \\
  S_2=P_2 \oplus D_1 \oplus D_3 \oplus D_4 \\
  S_3=P_3 \oplus D_2 \oplus D_3 \oplus D_4 \\
  \tag{2}
$$
  **若为000则无错，否则出错，且这个数就是数据位的位号**

## 流量控制与可靠传输机制

### 流量控制(链路层和传输层都有)

功能：**控制发送速度**，减少出错记录

> 链路层流量控制与传输层流量控制区别
>
> 1. 链路层流量控制是**点到点**的，是**相邻节点**(可能只有两层)之间的，其手段是**接收方要是收不下就不确认**
> 2. 传输层流量控制是**端到端**的，是主机(有五层协议的)之间的，其手段是**接收方给发送方一个发送窗口大小**

**方法**

1. **停止–等待协议**(发送窗口=1，接受窗口=1)

	每发送完一个帧就停止发送，等待对方的确认，在收到确认后再发下一个帧

	![image-20220802194846481](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220802194846481.png)

2. **滑动窗口协议**

	接收方收到一个正确的帧，则发送一个确认并将接受窗口后移一位；发送方收到一个正确的确认，则将发送窗口后移一位

	分类：

	- 后退N帧协议(GBN)：$发送窗口 \gt 1 \quad 接受窗口=1$
	- 选择重传协议(SR)：$发送窗口 \gt 1 \quad 接受窗口 \gt 1$

> **链路层的窗口大小在传输过程中可能不变，而传输层的窗口大小可能改变**

### 可靠传输、流量控制、滑动窗口之间的关系

可靠传输：发送方发啥，接收方收啥

流量控制：控制发送速率，使接收方能有足够的空间来接受每个帧

滑动窗口：解决可靠传输和流量控制问题

### 停止等待协议

> ![image-20220802195520682](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220802195520682.png)

#### 无差错情况

![image-20220803192730087](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220803192730087.png)

#### 有差错情况

##### 数据帧丢失或出错

发送一个帧后必须保留其副本，数据帧与确认帧必须编号

![image-20220803192935764](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220803192935764.png)

##### ACK(确认)丢失&ACK(确认)迟到

![image-20220803193219296](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220803193219296.png)

#### 性能分析

pros：简单

cons：信道利用率低

> 信道利用率
>
> **发送方在一个发送周期内，有效发送数据所需要时间占整个发送时间的比率**
> $$
> 利用率=\frac{\frac{L(比特)}{C(发送方数据传输率)}}{T(发送周期)} \\
> 吞吐量=利用率*发送速率
> \tag{1}
> $$
> 例题：一个信道的数据传输率为4kb/s，单向传输时延为30ms，如果使停止等待协议的信道利用率达到80%，要求的数据帧长至少为
> $$
> \frac{\frac{L}{4kb/s}}{\frac{L}{4kb/s}+2*30ms} \ge 80\% 
> \\ 
> L \ge 960kb
> \tag{2}
> $$

### ==GBN—回退N帧协议(流水线技术)==

#### 概述

> 必须扩大帧序号范围，发送方需要缓存多个分组
>
> 发送窗口：发送方维持的一组连续的允许发送的帧的序号
>
> 接收窗口：接收方维持的一组连续的允许接收的帧的序号

**GBN中$发送窗口 \gt 1 \quad 接受窗口=1$，当收到确认后发送窗口向后移动，==存在累计确认，偶尔捎带确认==**

> **累计确认：确认帧序列为n，n号与n号之前的所有帧都被发送方确认收到**
>
> **捎带确认：接收方在ACK上放一些数据**
>
> GBN发送方要做的事情
>
> 1. 上层调用
>
> 	上层要发送数据时，发送方先检查发送窗口是否满，若未满则生成一个帧并传输；若**满，发送方只需将数据传回上层**，让上层等一会再发送。(实际上发送方可以缓存这些数据，窗口不满后再发送)
>
> 2. 收到ACK
>
> 	GBN协议中，对n号帧的确认==**采用累计确认的方法**==，标明接收方已经收到n号帧与n号帧之前的所有帧
>
> 3. 超时事件
>
> 	若出现超时事件，发送方**需要重传所有已发送但未确认的帧**
>
> GBN接收方要做的事情
>
> - 如果正确接收帧且按序，那接收方为n帧发送ACK，并且将数据交付给上层
> - 其余情况直接丢弃帧，并为最近按序接收的帧重新发送ACK，接收方不缓存任何失序帧，只需要维护一个信息：expectedseqnum(下一个按序接收的帧序号)
> - **只按序接收，不按序直接丢弃；确认序列保存最大的按序到达的帧**

#### 运行过程

- ![image-20220803195523109](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220803195523109-16595277250251-16595277255883.png)

==Note：滑动窗口长度不能无限，**接收窗口=1，发送窗口=$2^n-1$(n为采用n个比特对序列进行编号)**；若发送窗口过大，接收方将无法正确区分新帧和老帧==

#### 性能分析

pros：信道利用率提高

cons：**重传时需要重传所有已发送未确认的帧，传送效率低**

### ==SR—选择重传协议==

#### 概述

**通过设置单个确认，同时加大接受窗口，并设置接受缓存，缓存已到达的帧；SR只重传出错的帧**

#### 滑动窗口

![image-20220807192128031](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220807192128031.png)

#### 一些要求

> SR发送方必须相应的三件事
>
> 1. 上层调用
>
> 	判断上层要发的数据是否在发送窗口中，若在则发送，不在则跟GBN一样要么缓存、要么交给上一层之后再传输
>
> 2. 接收方的确认
>
> 	如果收到ACK，且该序列在窗口内，则SR发送方将该帧标为已确认，若该帧在最左面则窗口向右移动到还未确认处，若窗口移动了且存在序号在窗口中的未发送帧，则发送
>
> 3. 超时重传
>
> 	**对每个帧都建立时钟**，超时则自动重传该帧
>
> SR接收方要做的事
>
> 1. 即**来者不拒**，不管是按序到达的还是不按序到达的正确帧接收方都接受，且只有接收窗口都接受完毕了才能将帧传给上层并移动窗口
> 2. **如果收到接受窗口左面的帧则直接返回确认帧，其他异常情况忽略**

#### 运行过程

![image-20220807193034978](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220807193034978.png)

Note：**发送窗口一般等于接收窗口(大于则会溢出，小了则没有意义)**
$$
W_{T_{max}}=W_{R_{max}}=2^{n-1}
\tag{1}
$$

## ==介质访问控制==

### 概述

传输数据用的两种链路

1. 点对点式

	**两个节点使用一条链路连接**，无第三方

	应用：**广域网、PPP协议**

2. 广播式

	**所有节点共用一条通信介质**

	应用：早期总线型以太网，局域网

	典型拓扑结构：总线、星

介质访问控制：采用一定措施使得==两节点之间的通信不会发生相互冲突==的情况(**可能在广播式链路中出现**)

![介质访问控制](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6.png)

### 信道划分介质访问控制

将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，把时域和频域资源合理分配给网络上的设备

#### 多路复用技术

把多个信号组合在一条物理信道上进行传输，使得多个PC或终端设备共享信道资源，提高信道利用率

![image-20220807200047270](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220807200047270.png)

把一条广播链路，逻辑上分成几条用于两个节点之间通信的互不干扰的子信道，即逻辑上把广播转为点对点

#### 频分多路复用FDM

用户在分到一定频率的频带后，在通信过程中将始终占用该频带

频分复用的所有用户在同样的时间占用不同的带宽(频率带宽)资源

充分利用频带资源；容易实现

![image-20220808192510118](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808192510118.png)

#### 时分多路复用TDM

![image-20220808192605298](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808192605298.png)

#### 统计时分复用STDM

改进的时分复用

![image-20220808192723448](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808192723448.png)
$$
\begin{aligned}
& v=8kb/s \\
& 对TDM \quad v_i=2kb/s \quad 每个资源只能用\frac{1}{4} \\
& 对STDM \quad v_i=8kb/s \quad 最高
\end{aligned}
\tag{1}
$$

#### 波分多路复用WDM

==波分多路复用=光的频分多路复用==

因为一根光纤中传输不同波长光信号，由于波长(频率)不同，所以各路光互不干扰，最后使用波长分解复用器，将各路波长分解出来

![image-20220808193303662](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808193303662.png)

#### 码分多路复用CDM

![image-20220808193508388](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808193508388.png)

### 随机访问介质访问控制

所有用户都可随时发送数据，可占全部带宽

#### ALOHA协议

##### 纯ALOHA协议

思想：**不监听信道，不按时间槽发送，随机发送，想发就发**

**每个帧在到达后，在缓存中等小于$T_0$时间后才能发送出去**

冲突如何检测：如果发生冲突，接收方就会检测出冲突然后不予确认(NAK或不发)，发送方在一定时间收不到就判定发生冲突：

冲突如何解决：**超时后等一随机时间再发，可能立刻发也可能过一会再发**

> 吞吐量：$S=Ge^{-2G}$，G为$T_0$时间内所有站点发送成功的和未成功而重传的帧数，S为吞吐量，其max值为$G=0.5$时$S=0.184$，可见吞吐量巨低
>
> ![image-20220808194602215](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808194602215.png)

##### 时隙ALOHA协议

思想：**将时间分为若干时间片，所有用户在时间片开始时刻同步接入网络信道，若发送冲突，则必须等到下一个时间片开始时刻再发送**

![image-20220808194803277](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220808194803277.png)

> 时隙ALOHA吞吐量大约是纯ALOHA协议的2倍，即0.368

#### CSMA协议(载波监听多路访问协议)—先听再说

CS：载波监听，每个站在**发送数据之前**要检查一下总线上是否有其他计算机在发送数据

> 当几个站同时发数据时，线路上可能会出现电压超过阈值的情况，我们将这种时刻看成出现碰撞

MA：多点接入，表示许多计算机以**多点接入的方式连接在一根总线上**

思想：发送前先监听信道，空闲则发送完整帧，忙则推迟发送

![CSMA协议](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/CSMA%E5%8D%8F%E8%AE%AE-16601305757642.png)

> 三种不同类型的CSMA协议比较
>
> | 信道状态 |           1-坚持CSMA           |               非坚持CSMA               |                          p-坚持CSMA                          |
> | :------: | :----------------------------: | :------------------------------------: | :----------------------------------------------------------: |
> |   空闲   | 信道空闲则直接发送，不需要等待 |     信道空闲则直接发送，不需要等待     | 信道空闲则以p概率直接发送，以1-p概率等到下一个时间槽再发送(p=1时退化成1-坚持CSMA) |
> |    忙    |          忙则一直监听          | 忙则放弃监听，等待随机一端时间后再监听 |                    忙则一直监听，直到空闲                    |

#### CSMA/CD协议(载波监听多点接入/碰撞检测协议)—边说边听

**采用隐式ACK(无人确认)，CSMA+CD(碰撞检测)**

CS：载波监听，每个站在**发送数据之前**和**发送数据时**要检查一下总线上是否有其他计算机在发送数据

MA：多点接入，表示许多计算机以多点接入的方式连接在一根总线上(总线型网络)

CD：碰撞检测(冲突检测)，“**边发送边监听**”，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据(**半双工网络**)

##### 传播时延对载波监听的影响

即在超过RTT的时间内还未检测到碰撞，则此次发送一定没有碰撞

![image-20220810193309070](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220810193309070.png)

##### 如何确定碰撞发送后重传时机

截断二进制指数规避算法

1. **确定基本退避(推迟)时间为争用期$2\tau=1RTT$**
2. 定义参数$k$，它等于重传次数，但$k$不超过10，即$k=min(重传次数，10)$
3. 从离散的整数集合${0,1,2,\dots,2^k-1}$中随机取一个数$r$，重传推迟时间是$2 \tau * r$
4. 当重传次数超过16次还不成功时，视为网络拥堵，认为该帧永远无法发出，抛弃此帧并向上层报错

> ![image-20220810193900853](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220810193900853.png)
> $$
> \begin{aligned}
> & \because 11 \gt 10 \\
> & \therefore k=10 \qquad \therefore 0-2^{10}-1
> \end{aligned}
> \tag{1}
> $$

##### 最小帧长问题

**用来在检测到碰撞时可以掐断传输，若过短则可能检测到碰撞时已经发完了**

==帧的传输时延至少要两倍于信号(数字或模拟)在总线中的传播时延==
$$
\begin{aligned}
& \because \frac{帧长}{数据传输速率} \ge 2 \tau=1RTT \\
& \therefore 帧长 \ge 2 \tau * 数据传输速率
\end{aligned}
\tag{1}
$$
**以太网最短帧长为64B**，小于64B的一律视为无效帧

#### CSMA/CA协议(载波监听多点接入/碰撞避免协议)—边说边听

**CA多用于无线，无法360°检测碰撞，存在隐蔽站**

使用**显式ACK**

> 隐蔽站：三个结点A、B、C
>
> 对A来说C就是一个隐蔽站，当A、C都检测到信道空闲时，同时向B发信号就会冲突

##### 原理

1. 发送数据前，先检测信道是否空闲
2. 空闲则发出**RTS(request to send)**，**RTS**包括**发送端的地址、接受端的地址、下一份数据将持续发送的时间等信息**，信道忙则等待  
3. 接受端收到**RTS**后，将响应**CTS(clear to send)**
4. 发送端收到**CTS**后，开始发送数据帧(同时预约信道：发送方告诉其他站点自己要传多久数据)
5. 接收端收到数据帧后，将用CRC(循环冗余检验)来检验数据是否正确，正确则响应**ACK**帧
6. **发送方收到ACK就可以进行下一个数据帧的发送，若没有就一直重传至规定重发次数为止**(采用**二进制指数规避算法**来确定随机的推迟时间)

主要有三个内容：**预约信道，ACK确认帧，RTS/CTS帧**  

#### ALOHA、CSMA、CSMA/CD、CSMA/CA对比学习

1. ALOHA协议可以分为纯ALOHA协议(想啥时候发就啥时候发)和时隙ALOHA协议(在同步时间片内随便发)，这两种协议都可以看成想发啥发啥，其主要的缺点是吞吐量低，分别是0.184和0.368

2. CSMA、CSMA/CD、CSMA/CA协议本质思想是一致的，都是边听边说

	CSMA主要有三种分别是**1-坚持CSMA、非坚持CSMA和p-坚持CSMA**，**1-坚持CSMA特点是信道空闲就直接发忙的时候也要一直听直到空闲**，而**非坚持CSMA特点是若信道忙则等待一个随机时间后再听**，**p-坚持CSMA则是在信道空闲时以p概率直接发送而1-p概率等到下一个时间槽再发**(若p=1则p-坚持退化为1-坚持)；**CSMA协议与其余两种协议的区别主要在于若出现碰撞，CSMA会一直发完本帧，而CSMA/CD和CSMA/CA则会在检测到出现碰撞时停止发送**

	**CSMA/CD协议和CSMA/CA协议的异同点**主要在于

	- 相同点：CSMA/CD和CSMA/CA都从属于CSMA协议的思路，都是**先听再说**
	- 不同点
		1. **传输介质不同**：CSMA/CD协议用于总线式以太网(有线)，而CSMA/CA协议用于无线局域网(无线)
		2. **载波检测方式不同**：CSMA/CD通过电缆中电压高低来检测；而CSMA/CA通过能量检测(ED)、载波检测(CS)和能量载波混合检测三种方式检测信道空闲的方式
		3. **CSMA/CD检测冲突，CSMA/CA避免冲突**，二者出现冲突后都会进行有上限的重传
		4. **CSMA/CD采用隐式ACK无人确认，CSMA/CA采用显式确认真有人确认**

### 轮询访问介质访问控制                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  

信道划分介质访问控制(MAC)协议：基于多路复用技术划分资源；网络负载重则共享信道效率高，网络负载轻则共享信道效率低

随机访问介质访问能控制协议：用户根据意愿随意发送资源，发送信息时可独占信道带宽；网络负载重则产生冲突，网络负载轻则信道效率高

轮询访问介质访问控制：上述两者结合，可分为轮询协议和令牌传递协议

#### 轮询协议

主节点轮流邀请从属结点发送数据

> 存在轮询开销(每次轮询都要发一条数据帧)，等待延迟(等前面的)，单点故障(主节点宕机就完蛋)

#### 令牌传递协议

![image-20220812192712530](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220812192712530.png)

**令牌环网：逻辑上是环，物理上是总线型**

**TCU转发器：传输数据帧时传递接口(转发接口)，传递所有接入的帧，为接入主机提供数据接口**

令牌：特殊格式的MAC(介质访问控制)控制帧，不含有任何信息；控制信道使用，确保同一时刻只有一个结点能独占信道

**无碰撞，无冲突**

##### 工作流程

![image-20220812193119761](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220812193119761.png)

在一定时间内占有令牌

##### 存在问题

有令牌开销，等待延迟和单点故障

> 应用于令牌环网，采用令牌传递的网络常用于**负载较重、通信量较大**的网络中

## 局域网

### 局域网的基本概念和体系结构

#### 概念与特点

局域网指在某一区域内由多台计算机互联成的计算机组

特点

1. **覆盖地理范围小**，只在一个相对独立的局部范围内互联，如一座或集中的建筑群中
2. 使用专门铺设的传输介质(双绞线、同轴电缆)进行联网，**数据传输速率高(10Mb/s-10Gb/s)**
3. **通信延迟时间短，误码率低，可靠性较高**
4. 各站为平等关系，共享传输信道
5. 多采用分布式控制和广播室通信，**能进行广播和组播**

决定局域网的主要要素为：**网络拓扑，传输介质与介质访问控制方法**

#### 网络拓扑

1. 星型拓扑—中间有集线器，n个主机n条线

	中间结点为控制中心，任意两点通信只需要两步，传输速度快

	网络构形简单，建网简单，便于控制和管理

	网络可靠性低，共享能力差，存在单点故障问题

2. 总线型拓扑—**常用，优势大造价低，以太网是逻辑上的总线型**

	网络可靠性高，网络结点间响应速度快，共享资源能力强

	设备投入量少，成本低，安装快

	存在单点故障问题

3. 环型拓扑

	系统中通信设备和线路比较节省

	存在单点故障问题，不便于扩展

	系统响应时延长，且信息传输效率相对较低

4. 树形拓扑

	易于扩展，易于隔离错误

	容易单点故障

后两者一旦确定，通信方向就随着确定

#### 传输介质

![局域网](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E5%B1%80%E5%9F%9F%E7%BD%91.png)

#### 介质访问控制协议

1. CSMA/CD

	常用于总线型局域网和树形网络

2. 令牌总线

	常用于总线型局域网和树形网络

3. 令牌环

	用于环形局域网

#### 分类–按介质访问控制协议分

1. 以太网

	标准以太网(10Mbps)，快速(100Mbps)，千兆(1000Mbps)，10G以太网(10Gbps)

	都符合IEEE802.3

	**逻辑拓扑为总线物理拓扑为星型，使用CSMA/CD协议**

2. 令牌环网

	物理上星，逻辑上环（已淘汰）

3. FDDI网—光纤分布式 

	物理上双环，逻辑上环

4. ATM网

	**单元交换技术，用53字节固定长度单元交换**

5. 无线局域网WLAN

	Wifi是一种WLAN实现技术，IEEE802.11

#### IEEE802标准

![image-20220812195320274](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220812195320274.png)

#### MAC子层和LLC子层

![image-20220812195438550](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220812195438550.png)

总而言之LLC子层是数据链路层与网络层相关的一部分，而MAC子层是与物理层相关的一部分

### 以太网与IEEE802.3

#### 以太网

Ethernet是一种基带总线局域网规范，是目前局域网最通用的通信协议标准，使用CSMA/CD协议

> 基带：数字信号；频带：模拟信号

##### 优点

- 便宜
- 应用广泛
- 比令牌环网，ATM便宜简单
- 满足网络速率要求范围大：10Mbps-10Gbps

##### 标准

1. PIX EtherNet V2：第一个局域网产品规格
2. IEEE802.3：帧格式相比V2有一点变更

满足上述二者任一便可看作是以太网

以太网提供的是无连接(不握手)、不可靠(不对发送方编号，接收方不确认，差错不修改直接丢弃)的服务，只实现无差错接受，不实现可靠传输

##### 传输介质与拓扑结构发展

![以太网传输介质与拓扑结构发展](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E4%BB%A5%E5%A4%AA%E7%BD%91%E4%BC%A0%E8%BE%93%E4%BB%8B%E8%B4%A8%E4%B8%8E%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84%E5%8F%91%E5%B1%95.png)

使用集线器的以太网仍旧还是一个总线网(还在同一广播域内)；各站共享逻辑上的总线(逻辑上是总线，物理上是星)

##### 10Base-T以太网

10BaseT是传送**基带信号**的**双绞线**以太网，T表示采用的是黄教先，10BaseT现在使用的是**无屏蔽双绞线**(UTP)，传输速度是**10Mbps**

**物理上采用星形拓扑，逻辑上总线型，每段双绞线最长100m**

采用**曼彻斯特编码**(先1后0为0，先0后1为1)，并采用CSMA/CD介质访问控制协议

##### 适配器

###### 适配器

计算机与外部有线局域网连接需要通过**通信适配器**连接；通信适配器也叫网络接口版、网络接口卡NIC，现在网卡焊死在主板中，不需要单独网卡

适配器有处理器和存储器(RAM{随机}、ROM(只读))，其中MAC地址就放在ROM中

###### MAC地址

在局域网中，物理地址也叫硬件地址或MAC地址，该地址全球唯一，用于分辨设备

MAC地址有48位，常用16位16进制数表示，前24位标识厂商后24位由厂商分配

##### 以太网MAC帧(商用)

![image-20220814194043938](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220814194043938.png)

- 前导码 8B

	前7B用来同步，后1B用来标志帧开始定界符

	**有开始定界符无结束定界符原因**：以太网使用曼彻斯特编码，若发送结束则信道一定没有变化，此时很方便就可以发现，且帧与帧之间存在最小间隔

- 目的地址 6B(48位MAC地址=48/8B=6B)

	目的地址共有三种情况，单播地址(目的主机MAC地址)、广播地址(全F)、多播地址

- 源地址 6B

- 类型 2B

	标识上层使用的网络协议

- 数据 46B-1500B
	$$
	\begin{aligned}
	& \because 以太网帧大小最小为64B \\
	& \therefore min=64-6-6-2-4=46B
	\end{aligned}
	\tag{1}
	$$
	最大帧长为1500B

- FCS 循环冗余检验余数

	循环冗余检验除数有国际规定

##### 商用帧与IEEE 802.3协议帧的区别

1. 第三个部分为类型/长度
2. 当类型/长度字段值小于0x600时，数据字段必须装入LLC子层(存在丢失风险)

#### 高速以太网

指速度超过100Mbps的以太网

1. 100Base-T以太网

	在**双绞线**上传送**100Mbps基带信号**的**星型以太网**，仍使用**IEEE802.3的CSMA/CD协议**

	支持**全双工和半双**工，可**在全双工方式下工作无冲突**(有交换机隔离冲突域)

2. 吉比特以太网

	在**光纤或双绞线**上传送**1Gbps**信号

	支持**全双工和半双**工，可**在全双工方式下工作无冲突**

3. 10吉比特以太网

	在**光纤**上传送**10Gbps**信号

	无冲突，不争用

### IEEE802.11与无线局域网

#### IEEE802.11

IEEE802.11有很多规范，其中IEEE802.11b+IEEE802.11g=Wifi

##### IEEE802.11的MAC帧头格式

![image-20220815192103602](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815192103602.png)

- 地址1为RA，即接收端MAC
- 地址2为TA，即发送端MAC
- 地址3为DA，即目的地址MAC
- 地址4为SA，即源地址MAC

![未命名文件 (1)](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20(1).png)

故此时DA即为B的地址，SA为A的地址，而TA和RA则可能会变化；

帧头类型如下：

|         功能          | To DS | From DS | Address1(接收端) | Address2(发送端) | Address3(目的地址) | Address4(源地址) |
| :-------------------: | :---: | :-----: | :--------------: | :--------------: | :----------------: | :--------------: |
|         IBSS          |   0   |    0    |        DA        |        SA        |       BSSID        |      未使用      |
|  To AP（基础结构型）  |   1   |    0    |  BSSID(AP地址)   |        SA        |         DA         |      未使用      |
| From AP（基础结构型） |   0   |    1    |        DA        |      BSSID       |         SA         |      未使用      |
| WDS（无线分布式系统） |   1   |    1    |        RA        |        TA        |         DA         |        SA        |

#### 无线局域网

分类如下

##### 有固定基础设施的无线局域网

![image-20220815193350284](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815193350284.png)

##### 无固定基础设施的无线局域网的自组织网络

![image-20220815193357122](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815193357122.png)

无集线器路由器等设备，只有主机各自平等

### PPP协议与HDLC协议

二者一般用于广域网

#### 广域网(WAN)

物理范围大如Internet，**通信子网使用分组交换技术**，可用公用分组交换网、卫星通讯网、无线分组交换网，将各地局域网连接起来达到资源共享的目的

> 广域网最顶层为网络层，局域网最顶层为链路层

![image-20220815194258247](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815194258247.png)

#### PPP协议

点对点，使用字符，使用最广泛(拨号上网)，**只支持全双工链路**，**面向串行链路**

**要求**

1. 简单：对链路层帧无纠错，无序号，无流量控制
2. 封装成帧
3. 透明传输：处理帧中非法字符，如同步线路使用比特填充法、异步线路使用字节填充法
4. 多种网络层协议：对上次IP协议无所谓
5. 多种类型链路：连接的链路类型无所谓
6. 差错检测：使用CRC循环冗余检验，若错就丢弃
7. 检测链路连接状态：链路是否正常工作
8. 最大数据传输单元：MTU$\le$1500
9. 网络层地址协商：让双方确认对方网络层地址
10. 数据压缩协商

PPP协议**无需**纠错、流量控制、不进行编号、不支持多点通信

**主要的三个功能/三个组成部分**

1. 链路控制协议LCP：一种扩展链路控制协议，用于建立、配置、测试和管理数据链路
2. 网络控制协议NCP：PPP可以支持多种网络层协议，每个不同的网络层协议都有一个相应的NCP来配置，为网络层协议建立和配置逻辑连接
3. 一个将IP数据报封装到串行链路(可能是同步的也可能是异步的)的方法：IP数据报即PPP数据帧的数据部分，其长度受MTU的限制

**状态**

![image-20220815195811322](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815195811322.png)

**帧格式**

![image-20220815195913110](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220815195913110.png)

- F：7E为16进制，即01111110，一个填充字段
- A：地址字段，固定为11111111
- C：控制字段，固定为00000011
- 协议：表示信息部分是什么，到底是IP数据报还是LCP数据还是网络控制数据
- IP数据报中的转义字符为TD=01111101
- FCS：CRC循环冗余检验余数
- F：同第一个字段，为字符填充字段

#### HDLC协议

点对点，**面向比特**，不属于TCP/IP协议组，由ISO制定；**可透明传输，0比特插入法**，易硬件实现；**使用全双工通信**；所有帧都采用CRC检验，对信息帧进行顺序编号，可防止漏传或重发，传输可靠性高

**站的分类**

![HDLC的站](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/HDLC%E7%9A%84%E7%AB%99.png)

**三种数据操作方式**

1. 正常响应方式
2. 异步平衡：每个复合站都可以发
3. 异步响应：从站可以随便发

**帧格式**

![image-20220816192549941](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220816192549941.png)

- 标志F 8位：标志帧开始

- 地址A 8位：可用从站或应答站的地址

- 控制C 8位：

	信息帧：第一位为0，用来传输数据信息，或使用捎带技术对数据进行确认

	监督帧：10，用于流量控制和差错控制，执行对信息帧的确认、请求重发或请求暂停发送等

	无编号帧：11，用于提供对链路的建立、拆除等多种控制功能

- 注意在透明传输区间使用了0比特插入法，即5个连续的1插入一个0

#### PPP协议与HDLC协议异同点

相同点

- 两者都全双工

- 两者都实现了透明传输

	PPP在异步传输时使用字符填充，同步时使用比特填充；HDLC使用0比特填充法

- 都使用CRC进行差错检验，但其不会纠正

不同点

| PPP协议  | 面向字符 | 帧中有2B协议字段 | 帧无编号 | 不可靠 |
| -------- | -------- | ---------------- | -------- | ------ |
| HDLC协议 | 面向比特 | 无               | 帧有编号 | 可靠   |

## 链路层设备

见上

# 网络层

## 网络层的功能

![网络层](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/%E7%BD%91%E7%BB%9C%E5%B1%82.png)

主要任务：把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务

传输单位：数据报，分组是数据报的一部分

功能

1. 路由转发与分组转发

2. 异构网络互联，如Wifi、4G等

3. 拥塞控制–防止数据报过多

	开环控制–静态：设计网络时就考虑好会不会拥塞

	闭环控制–动态：事先不考虑，采用检测网络系统区监视，及时检测哪里有拥塞

## IPv4

### IPv4分组

#### IPv4分组的格式

![image-20220820194544796](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220820194544796.png)

具体格式如下：

![image-20220820194701782](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220820194701782.png)

1. 版本

	IPv4/IPv6，常用值为4，长度为4bit

2. 首部长度

	长度为4bit，最大可表示值为15，每1bit表示首部有4B=32位

	故首部长度最大值为60B，所以固定首部20B，可变首部40B；最小值为5，常用值也是5

	填充字段将首部字段填充为4B的整数倍

3. 区分服务

	长度为8bit，**期待哪种类型的服务**，有用时才用

4. 总长度

	长度为16bit，表示IP数据报长度，每1bit表示IP数据报有1B

	故最大为$2^{16}-1$B，**以太网MTU为1500B**

5. 标识

	长度为16bit，一个计数器，每产生一个数据报就加1，并复制给标识字段，但其不是序号(因为IP是无连接服务)，故当一个数据报长度超过MTU时必须分片，且每个数据报分片都复制一次标识号

6. 标志

	长度为3bit，**标志中间一位为DF，只有DF=0时允许分片；标志最后一位为MF，MF=1表示后面还有分片，MF=0表示为分组最后一个分片**

7. 片偏移

	长度为13位，表示较长报文在分组后某片在原分组中的位置

	**基本单位为8B**，即每1bit表示8B的长度，同时表明**除了最后一个分组，分组长度一定为8B整数倍**

8. 生存时间(TTL)

	长度为8位，表示IP分组保质期

	每经过一个路由器生存时间减1，变为0时则表示其失效

9. 协议

	长度为8位，表示此分组数据报数据部分使用什么协议

	**值为6则为TCP，值为17则为UDP，值为41则为IPv6**

10. 首部校验和

	长度为16位，只检验首部，使用二进制求和检验

11. 源地址字段

	IPv4地址，32位，发送方IP地址

12. 目的地址字段

	IPv4地址，32位，接收方IP地址

> IP数据报一般前12B为控制字段，之后的8B分别为源地址4B和目的地址4B

#### IP数据报分组

**MTU为链路层数据帧最大数据量，一般以太网的MTU为1500B，许多广域网MTU$\le$576B**

当IP数据报长度大于MTU时就需要分片(DF=0)，**若DF=1则不能分，需要返回ICMP控制报文**

1. 标识：同一数据报的分片标识都一样，长度为16位

2. 标志：只有两位有意义，长度为3位；

	- DF=1：不分片
	- DF=0
		- MF=1：后面还有分片
		- MF=0：最后一个分片

3. 片偏移：片在数据报中的哪一个位置，长度为13位，单位为8B

	**除了最后一个分组，分组长度一定为8B整数倍**

> ![image-20220822193517621](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220822193517621.png)

> ==**总长度：16位，单位为1B**==
>
> ==**首部长度：4位，单位为4B**==
>
> ==**片偏移：13位，单位为8B**==

### IPv4地址与NAT

#### IPv4地址

连到Internet上的主机(路由器)都分配一个32bit的全球唯一的标识符即IP地址；IP地址由互联网名字和数字地址分配结构ICANN进行分配
$$
分类 \to 子网划分 \to 超网
\tag{1}
$$

> 采用点分十进制的方法标识，如223.1.1.1
>
> 路由器有2个或2个以上的IP地址，每个接口都有一个不同的IP地址
>
> **无编号网络：路由器之间连线的网络**

##### 分类网络

IP地址={<网络号>,<主机号>}

![image-20220822194421059](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220822194421059.png)

| NetID网络号 | HostID主机号 | 作为IP地址的源地址 | 作为IP地址的目的地址 |                             用途                             |
| :---------: | :----------: | :----------------: | :------------------: | :----------------------------------------------------------: |
|     全0     |     全0      |        可以        |        不可以        | 表示本网范围内表示主机，路由表中用于表示默认路由(表示整个Internet网络) |
|     全0     |    特定值    |        可以        |        不可以        |                    表示本网中某个特定主机                    |
|     全1     |     全1      |       不可以       |         可以         | **整个TCP/IP网的广播地址，但路由器对广播域进行了隔离，故全1地址等效于本网的广播地址** |
|   特定值    |     全0      |       不可以       |        不可以        |                    网络地址，表示一个网络                    |
|   特定值    |     全1      |       不可以       |         可以         |         直接广播地址，对特定网络上的所有主机进行广播         |
|     127     |    任何数    |        可以        |         可以         | **用于本地换回网络测试**，称为换回地址；**目的地址为换回地址的IP数据报不会出现在任何网络上** |

##### 私有IP地址

| 地址类别 |          地址范围           | 网段个数 |
| :------: | :-------------------------: | :------: |
|   A类    |   10.0.0.0~10.255.255.255   |    1     |
|   B类    |  172.16.0.0~172.31.255.255  |    16    |
|   C类    | 192.168.0.0~192.168.255.255 |   256    |

路由器对目的地址为私有IP地址的数据报一律不转发

##### 分类IP网

|      |     最大可用网络数      | 第一个可用的网络号 | 最后一个可用的网络号 |           最大主机数           |
| :--: | :---------------------: | :----------------: | :------------------: | :----------------------------: |
| A类  | $2^7-2$，全0和127不可用 |         1          |         126          | $2^{24}-2$，全0(本网)全1(广播) |
| B类  |  $2^{14}-1$，全0不可用  |       128.1        |       191.255        |           $2^{16}-2$           |
| C类  |  $2^{22}-1$，全0不可用  |      192.0.1       |     223.255.255      |            $2^8-2$             |

#### 网络地址转换NAT

NAT：**通过专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址**。它使得整个专用网只需要一个全球IP地址就可以与因特网联通。

在专有网连接到因特网上安装NAT软件；安装NAT软件的路由器就是NAT路由器，**至少有一个有效的外部全球地址**。关键在于**NAT路由器使用NAT转换表将私有IP转换为公有IP**

有端口号的参与，故**NAT应该为传输层协议**

|  WAN段(广域网)  |              LAN段(局域网)               |
| :-------------: | :--------------------------------------: |
| 外部IP：端口号1 | 私有IP1：端口号1(端口号唯一标识一个进程) |
| 外部IP：端口号2 |              私有IP2：端口2              |
|       ……        |                    ……                    |

> 例子
>
> ![image-20220823192411720](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220823192411720.png)

### 子网划分与子网掩码CIDR

#### 子网划分

> 分类IP地址缺点
>
> 1. IP地址空间利用率有时很低
> 2. 两级IP地址不够灵活

 ![image-20220823192638180](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220823192638180.png)

**子网全0或全1时可能不能用(有CIDR可以用，无CIDR不能用)，主机号不能全0(表示本网)，不能全1(本网广播地址)**

过程：**外部先连接到本单位上的路由器，然后该路由器根据目的网络号中的子网号找到目的网络号，然后交付给目的主机**

#### 子网掩码

![image-20220823193216388](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220823193216388.png)

**将IP地址与三级IP子网掩码逐位相加，就可以得到子网网络地址**

> 1. IP地址为142.14.72.24，子网掩码为255.255.192.0，求网络地址
>
> 	网络地址为142.14.64.0
>
> 2. 某主机的IP地址为180.80.77.55，子网掩码为255.255.252.0.若该主机向其所在子网发送广播分组，则目的地址可以是
>
> 	网络地址为180.80.76.0，故广播地址为180.80.79.255

##### 使用子网时分组的转发

前提：路由器有路由表，**路由表有目的网络地址、目的网络子网掩码、下一跳地址**

###### 路由转发算法

1. 从收到的IP分组的首部提取目的主机的IP地址D(即目的地址)
2. 若查找到特定的主机路由(目的地址为D)，就按照这条路由的下一跳转发分组；否则从转发表中的下一条(即按前缀长度的顺序)开始检查，执行步骤3
3. 将这一行的子网掩码与目的地址D进行按位与运算，若运算的结果与本行的前缀匹配，则查找结束，按照下一条指出的进行处理(或者直接交付本网络的上的目的主机，或通过指定接口发送到下一跳路由器)。否则，若转发表还有下一行，则对下一行进行检查，重新执行步骤3，否则执行步骤4
4. 若转发表中有一个默认路由，则把分组传送给默认路由；否则，报告转发分组出错

#### CIDR–无分类编址

| 网络前缀 | 主机号 |
| :------: | :----: |

网络前缀是可变长的

1. 消除了A、B、C类地址，以及划分子网的概念
2. 融合子网地址与子网掩码，方便子网划分

![image-20220823195749275](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220823195749275.png)

> 192.199.170.82/27
>
> 1. 几个IP地址：$2^5$
>
> 2. 最小地址：192.199.170.80
>
> 	最大地址：192.199.170.95
>
> 3. 地址块：192.199.170.80/27
>
> 4. 地址掩码：255.255.255.230

#### 应用

##### 构成超网

将多个子网聚合成一个较大的子网便是**构成超网(路由聚合)，防止路由表过大**；方法是将网络前缀缩短(所有网络地址取交集)

> 某路由表有转发接口相同的4条路由表项，目标地址分别是35.230.32.0/21、35.230.40.0/21、35.230.48.0/21、35.230.56.0/21，将该4条路由聚合后的目的网络地址为？
>
> 32：00100000
>
> 40：00101000
>
> 48：00110000
>
> 56：00111000
>
> 可见前三位一致，故聚合后为35.230.32.0/19

##### 最长前缀匹配

**使用CIDR时，查找路由表可能得到几个匹配成功结果(按位相与)，应选择有最长网络前缀匹配的路由，前缀越长，地址块越少，路由越具体**

> ![image-20220824192803012](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220824192803012.png)

### ARP、DHCP与ICMP

#### ARP

无论网络层使用什么协议，在实际网络的链路上传输数据帧时，最终都必须使用硬件地址。所以需要一致方法来**完成IP地址到MAC地址的映射**，这就是地址解析协议ARP

各主机/路由器都有**ARP缓存(IP与MAC地址的映射)**，用来存放本局域网上各主机和路由器的IP地址到MAC地址得到映射表，称为**ARP表**。**使用ARP协议来维护ARP表**

**工作原理**如下：

主机A欲向本局域网上的主机B发送IP数据报

1. 在**ARP高速缓存中查看有无主机B的IP地址**
2. 若有，就可查出对应的MAC地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址
3. 若没有，就通过使用**目的MAC地址为FF-FF-FF-FF-FF-FF的帧**来封装并广播ARP请求分组，使同一个局域网内的所有主机都收到此ARP请求。主机B收到该ARP请求后，向A发出**ARP响应分组**(单播发送)，分组中包含主机B的IP与MAC地址映射关系，主机A收到后将该映射关系写入ARP缓存中，然后发送MAC帧

若跨局域网发送，则**将MAC地址设为路由器默认网关的MAC地址，IP地址还是原来的IP目的地址**

可见**ARP协议应该为网络层协议**

> 由于ARP协议找不到不同网段的MAC地址，故传输过程中MAC地址会一直变而IP地址则一直不变
>
> IP地址发送变化的是NAT地址(私有变公有)

**特点：**实际网络上一定要使用MAC地址，但有的主机不知道其他人的MAC地址故需要ARP协议

![image-20220824194813174](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220824194813174.png)

**ARP次数等于路由器个数+1(跨网段时)**

#### DHCP

**DHCP是一个应用层协议，使用客户/服务端协议，客户端与服务端用广播通信，基于UDP；**

提供即插即用联网的机制，主机从服务器动态地获取**IP地址、子网掩码、默认网关、DNS服务器名称与其IP地址**；允许地址重用，支持移动用户加入网络，支持在用用户缓租

> 主机获取IP地址的方式有两种
>
> 1. 静态
>
> 	如机房电脑，主要配置：IP地址、子网掩码、默认网关
>
> 2. 动态
>
> 	给主机动态地分配IP地址

**工作流程**

![image-20220824195536428](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220824195536428.png)

#### ICMP(网际控制报文协议)

**ICMP是一个网络层协议**，在网络层和传输层之间交换信息(更有效地转发IP数据报和提高交付机会)

支持主机/路由器；有差错报告；有网络探询

##### 报文格式

![image-20220825191536676](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825191536676.png)

- 类型：哪种ICMP报文
- 代码：细分
- 校验和：校验整个ICMP首部

##### 类型

ICMP可分为**ICMP差错报告报文和ICMP询问报文**

###### ICMP差错报告报文

要发送ICMP差错报告报文的情况

- 终点不可达：路由器或主机无法交付报文                             无法交付
- 源点抑制：路由器或主机由于拥塞无法发送数据报              拥塞(已取消)
- 时间超时：路由器TTL=0或终点未按时全收到，将收到的全丢弃
- 参数问题：首部字段有问题
- 改变路由：传输过程中出现了更好的路由

不应发送ICMP差错报告报文的情况

- 对**ICMP差错报告报文**不发送ICMP差错报告报文
- 对第一个分片的数据报片的所有**后续数据报片**都不发送ICMP差错报告报文
- 对具有**组播地址的数据报**都不发送ICMP差错报告报文
- 对具有**特殊地址(如127.0.0.0或0.0.0.0)的数据报**不发送ICMP差错报告报文

> ICMP差错报告报文格式
>
> ![image-20220825192403362](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825192403362.png)

###### ICMP询问报文

1. **回送请求和回答报文**

	主机/路由器**向特定目的主机发出询问，收到此报文的主机必须回答**；可以用来测特定点的状态和是否可达

	应用如PING

2. **时间戳请求和回答报文**

	请某个主机/路由器回答当前时间

	用来同步时间

3. **地址掩码请求和回答报文**

4. **路由器询问和通告报文**

	后两者已不用了

##### 应用

PING、Traceroot：跟踪一个分组从源到目的的路径，使用ICMP时间超过差错报文

## IPv6

### IPv6主要特点

解决IPv4地址不够的三种方式：**CIDR、NAT、IPv6(根本解决)**

主要特点是：

1. 改进首部格式

	可以快速处理/处理数据

2. 支持QoS—服务指令

	一种安全机制，用来解决网络延迟和阻塞的一种技术

### IPv6地址

#### 数据报格式

![image-20220825193625119](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825193625119.png)

- IPv6首部固定40B，可选扩展首部，算入有效载荷
- 下一个首部在固定首部和扩展首部都存在

#### 与IPv4区别

1. IPv6将地址**从32位(4B)扩展到128位(16B)**，更大的地址空间
2. IPv6将IPv4的**校验和字段移除**，以减少每跳的处理时间
3. IPv6将IPv4的可选字段移除首部，变成了**扩展首部**，成为了灵活的首部格式，路**由器通常不对扩展首部进行检查**，大大提高了路由的处理效率
4. IPv6支持即插即用(即自动配置)，不需要DHCP协议
5. IPv6首部长度必须是**8B的整数倍**，IPv4是**4B的整数倍**
6. **IPv6只能在主机处分片，IPv4可以在路由器和主机处分片**
7. ICMPv6：附加报文类型“分组过大”
8. IPv6**支持资源的预分配**，支持实时视像等要求，保证一定的带块和时延的应用
9. IPv6**取消了协议字段**，改成下一个首部字段
10. IPv6**取消了总长度字段**，改用有效载荷长度
11. IPv6**取消了服务类型字段**

#### 地址表示形式

冒号16进制记法，如*4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170*

压缩：连续的4个0只记一个，如*4BF5:0:0:BA5F:391:A:2176*

零压缩：一连串连续的0用一对冒号取代，只能用一次

一般来说合并前导0

- 0000:0000:0F53:6382:AB00:67DB:BB27:7332		::F53:6382:AB00:67DB:BB27:7332
- 0000:0000:0000:0000:0000:0000:004D:ABCD        ::4D:ABCD
- 0000:0000:0000:AF36:7328:000A:87AA:0398         ::AF36:7328:A:87AA:398
- 2819:00AF:0000:0000:0000:0035:0CB2:B271         2819:AF::35:CB2:B271

#### 基本地址类型

- 单播：一对一通信，可做源地址+目的地址
- 多播：一对多通信，可做目的地址
- 任播：一对多中的一个通信，可做目的地址；一般是距离最近的一个

#### IPv4过渡策略

![image-20220825195327991](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220825195327991.png)

## 路由算法

### 静态路由与动态路由

**静态路由(非自适应路由)—管理员手动配置路由信息**

- pros：简单可靠，在负荷稳定、拓扑变换不大的网络中运行效果好；广泛运用于军事网络或较小的商业网络
- cons：路由更新慢，不适用于大型网络

**动态路由(自适应路由)—路由器间彼此交换信息，按路由算法来优化出路由表项**

- pros：更新快，适用于大型网络，及时适应拓扑变换

- cons：算法复杂，增加了网络负担

- 可以分为

	- **全局性—链路状态路由算法    OSPF协议   大网络**

		所有路由器掌握完整的网络拓扑和链路复用协议

	- **局部性—距离向量路由算法    RIP协议       小网络**

		只掌握邻居的链路费用

### 分层次的路由选择协议

因为因特网规模很大、许多单位不想让外界知道自己的路由选择协议，但还想连入因特网，故引入自治系统AS

**自治系统AS**：**在单一的技术管理下的一组路由器**，而这些路由器使用一种**AS内部的路由选择协议和共同的度量以确定分组在该AS内的路由**，同时还使用**一种AS之间的路由协议以确定在AS之间的路由**

**一个AS内的所有网络都属于一个行政单位来管辖，一个自治系统的所有路由器在本自治系统内都必须连通**

![image-20220826192326511](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220826192326511.png)

### RIP协议与距离向量算法

#### RIP协议

RIP是一种**分布式的基于距离向量**的路由选择协议，是互联网的协议标志，最大的优点是简单

**RIP协议要求网络中的每个路由器都维护一个自己到其他目的网络的唯一最佳距离记录**(即一组距离)

**距离：通常是跳数**，即源端口到目的端口经过的路由器个数，**经过一个路由器跳数+1**。特别的，从路由器到直接相邻的网络距离为1.RIP允许一条路由最多经过15个路由器，**即跳数为16表示网络不可达**

**RIP只适用于小网络**

1. 和哪些路由器交换信息：相邻路由器
2. 交换什么信息：路由表
3. 在什么时候交换信息：**30s一次，根据新信息更新路由表；超过180s没收到邻居路由器的消息则默认邻居没了并更新自己的路由表**

![image-20220826193237968](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220826193237968.png)

> 路由器刚开始工作时，只知道直接连接的网络的距离(1)，接着每一个路由器也只和数目非常有限的邻居路由器交换并更新路由信息
>
> 经过若干次更新后，所有路由器最终都会知道到达本自治系统任何一处网络的最短距离(距离向量算法)和下一条路由器的地址，即收敛

#### 距离向量算法

##### RIP报文格式

RIP报文：路由器使用RIP协议时交换路由信息所用报文，大致格式如下

**RIP为应用层协议，使用UDP传送数据；一个RIP报文最多包括25个路由，若超过则需要更多的RIP报文**

![image-20220826194517690](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220826194517690.png)

##### 距离向量算法运行过程

1. **修改相邻路由器发来的RIP报文**

	对地址为X的相邻路由器发来的RIP报文，把下一条字段中的地址改为X，并把所有的距离+1

2. 对修改后的RIP报文中的每一个项目进行如下操作

	若路由表中没有当前项目的目的地址，则加入路由表

	若路由表中有当前项目的目的地址，则查看下一跳路由表地址

	**若下一跳是X，则更新**

	若不是，则路由表中的距离比报文中的距离远则更新，否则不处理

3. 若180s还没有收到邻居路由器发来的报文，则默认该路由器寄了，把该路由器记为不可达的路由器，将距离改为16

4. 返回

> 1. ![image-20220826194413473](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220826194413473.png)
>
> 	首先对R4发来的路由进行修改
>
> 	| 目的网络 | 距离 | 下一跳路由器 |
> 	| :------: | :--: | :----------: |
> 	|   Net1   |  4   |      R4      |
> 	|   Net2   |  5   |      R4      |
> 	|   Net3   |  2   |      R4      |
>
> 	再更新R6的路由表
>
> 	| 目的网络 | 距离 | 下一跳路由器 |
> 	| :------: | :--: | :----------: |
> 	|   Net2   |  5   |      R4      |
> 	|   Net3   |  2   |      R4      |
> 	|   Net1   |  4   |      R4      |
>
> 2. ![image-20220826195204560](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220826195204560.png)
>
> 	首先修改传过来的RIP报文
>
> 	B(11,6,14,18,12,8)
>
> 	D(19,15,9,3,12,13)
>
> 	E(12,11,8,14,5,9)
>
> 	然后更新C的路由表
>
> 	(11,6,0,3,5,8)，故选B

#### 距离向量特点

好消息快，坏消息慢–报喜不报忧

> ![image-20220826195738540](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220826195738540.png)

### OSPF协议与链路状态算法

#### OSPF协议

开放最短路径优先OSPF协议，使用Dijskra算法

**特征：分布式的链路状态算法**

![image-20220829192124684](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829192124684.png)

#### 链路状态算法

![image-20220829192408832](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829192408832.png)

#### OSPF的区域

**为了让OSPF作用于规模更大的网络，OSPF将自治系统再划分成若干个更小的范围，叫做区域。每个区域都有一个32位的区域标识符(点分十进制表示)**

**一个区域内一般不超过200个路由器**

- 主干区域：0.0.0.0，连通其他区域
- 主干路由器：主干区域内的路由器
- 区域内部路由器：区域内的路由器
- 区域边界路由器：连接两个区域内的路由器；**主干区域的区域边界路由器也是主干路由器**
- 自治系统边界路由器：主干区域连接其他自治系统的路由器

![image-20220829193020040](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829193020040.png)

#### OSPF的分组

![image-20220829193054978](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829193054978.png)

#### 其他特点

1. **每隔30min，刷新一次数据库中的链路状态**
2. **由于一个路由器的链路状态只与相邻路由器有关，因此与整个互联网的规模并无关系，故互联网规模大时，使用OSPF协议**
3. OSPF没有报喜不报忧的问题，收敛速度快

### BGP协议(边界网关协议)

和谁交换：与**其他自治系统的邻站BGP发言人发送信息**

- BGP发言人：BGP邻界路由器
- 几个发言人用网络连接在一起

交换什么：交换网络可达性的信息，即要到达某个网络要经过的一系列自治系统

多久交换：当网络可达性发生变换的时候

#### BGP交换信息过程

![image-20220829193855555](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829193855555.png)

AS最佳路径不好找，故较好就行；AS之间是树形连接的，防止绕圈；BGP发言人有AS内部路由协议也有AS外部路由协议

#### BGP协议报文格式

**BGP是应用层协议，使用TCP传输；使用TCP原因：安全，路由简化**

![image-20220829194133924](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829194133924.png)

#### 特点

- **BGP支持CIDR**，故BGP的路由表包括目的网络前缀，下一跳路由器，以及到达目的网络要经过的各个自治系统序列
- 在BGP刚刚运行时，BGP的邻站是交换整个BGP路由表，但之后只有在路由表项更新时才会更新

#### BGP的4种报文

![image-20220829194516545](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220829194516545.png)

### 三种路由协议比较

**RIP和OSPF是自治系统内部路由选择协议**：RIP是分布式距离向量算法，适用于较小的互联网，有着报喜不报忧的特点，是应用层协议，基于UDP，交换的是邻接路由器的路由信息；而OSPF是分布式链路状态算法，适用于较大的互联网，使用迪杰斯坷垃算法，有着收敛快的特点，是网络层协议，交换的是链路状态

而**BGP协议是自治系统间路由选择协议**，在不同的自治系统之间交换路由信息，由于自治系统间网络环境复杂，需要可靠性，故是应用层协议，基于TCP，交换的是到达某个网络的全部路径

|   协议   |                    RIP                     |                 OSPF                 |                       BGP                        |
| :------: | :----------------------------------------: | :----------------------------------: | :----------------------------------------------: |
|   类型   |            自治系统内部路由算法            |         自治系统内部路由算法         |                自治系统间路由算法                |
| 路由算法 |                距离向量算法                |             链路状态算法             |                   路径向量算法                   |
| 传递协议 |                    UDP                     |                  IP                  |                       TCP                        |
| 路径选择 |                  跳数最少                  |               代价最低               |                   较好，非最佳                   |
| 交换结点 |            和本结点相邻的路由器            |           网络中所有路由器           |               和本结点相邻的路由器               |
| 交换内容 | 当前本路由器知道的所有信息，即自己的路由表 | 与本路由器相邻的所有路由器的链路状态 | 首次需要交换整个路由表，之后就只交换有变化的部分 |

> RIP使用UDP，OSPF使用IP，而BGP使用TCP，这样做有何优点？为什么RIP需要周期性的和邻站交换路由信息而BGP不这样做
>
> 1. RIP为应用层协议，RIP接收的路由信息都被封装在UDP数据报中
>
> 	OSPF为网络层协议，由于要传输的信息量大，所以应使报文的长度尽量短，因此使用IP
>
> 	BGP为应用层协议，主要负责自治系统间交换网络可达性，由于网络环境复杂故需要可靠性，故使用TCP
>
> 2. 内部网络协议主要设法将数据报在一个自治系统内尽可能有效的从源站传输到目的站，在一个自治系统内部并不需要考虑其他方面的问题，而BGP使用环境不同
>
> 	主要有三个原因：1.因特网规模过大，使得自治系统间的路由选择十分困难；2.对于自治系统之间的路由选择，找出最优的路由不现实；3.自治系统之间的路由选择必须考虑其他因素
>
> 	因此BGP只需要找到较好的路由即可，故BGP不需要周期性的与邻站交换路由信息

## IP组播

### IP组播概念

![image-20220830191017148](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220830191017148.png)

总之

- 单播：一对一
- 广播：一对多，广播域内一个报文大家都收
- 组播：一对多，可跨广播域，发送方只发一份，由组播路由器支持

**组播一定仅作用于UDP**

### IP组播地址

IP组播允许源设备能将分组发送给一组设备；属于多播组的设备将被分配一个组播IP地址(一群共同需求主机的相同标识)

**地址范围**：224.0.0.0~239.255.255.255(D类地址)，一个D类地址表示一个组播地址；只能用作分组的目的地址，源地址一定是单播地址

> 1. 组播数据报尽最大努力交付，不提供可靠交付，应用于UDP
> 2. 对组播数据报不产生ICMP差错报文
> 3. **并非所有的D类地址都是组播地址**

实现方法有：

1. 硬件组播：局域网内组播
2. 因特网范围内组播

#### 硬件组播

![image-20220830191927358](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220830191927358.png)

组播MAC就是01-00-5E-0+IP地址后23位

### IGMP与组播路由协议

#### IGMP协议

网络层协议，使用IP数据报传输

**让路由器知道本局域网上某个主机是否参与或退出了某个组播组**

工作的两个阶段

1. 某主机要加入组播组时，该主机向组播组的组播地址发送一个IGMP报文，声明自己要加入

	本地组播路由器收到IGMP报文后，要**利用组播路由选择协议将这组成员关系发到因特网上的其他组播路由器**

	由于目的地址为组播地址，故组播组内所有主机都能收到

2. **本地组播路由器周期性探询本地局域网上的主机，以便知道这些主机是否还是组播组的成员**

	只要有一个主机对某个组响应，那么组播路由器就认为该组活跃，若经过几轮没有主机响应，组播路由器就认为该局域网上没有组播主机，因此不再把这组成员关系发送给其他组播路由器

	此处使用了IGMP询问报文，只要有一个响应就行，减少通信量

**由上可以看出，组播路由器知道的成员关系仅仅是本局域网上是否有组播组的成员**

#### 组播路由选择协议

找出以源主机为根节点的组播转发数(防止转圈)；**对不同的多播组对应于不同的多播转发树，同一个多播组，对不同的源点也会有不同的多播转发树**

三种算法

1. 基于链路状态
2. 基于距离向量
3. 协议无关的组播(稀疏指离得远/密集指离得近)，对单播路由协议无要求

> 因特网的组播是怎样实现的？为什么因特网上的组播比以太网上的组播复杂得多？
>
> - 因特网的组播是靠路由器来实现的，这些路由器必须增加一些识别组播的硬件，能够运行组播协议的路由器是一个单独的路由器，也可以是运行组播协议的普通路由器
> - 因特网上的组播比以太网上的复杂，因为以太网本身有广播和组播功能，而因特网上大部分当前网络和许多物理网络不支持广播和组播功能

## 移动IP

### 移动IP的概念

![image-20220830193708141](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220830193708141.png)

### 通信过程

在移动IP中，每个移动结点都有一个唯一的本地地址，当移动结点移动时，它的本地地址不变，在本地网络链路上每个移动结点还必须有一个本地代理来为它维护当前的位置信息，这就需要引入转交地址

当移动结点连接到外地网络链路上时，转交地址就用来表示移动结点现在所处的位置，以便进行路由选择。移动结点的本地地址与当前转交地址的联合称为**移动绑定**或者**绑定**

当移动结点得到一个新的转交地址时，通过绑定向本地代理进行注册，以便让本地代理即时了解移动结点的当前位置

基本通信流程如下

1. 移动结点在本地时，按传统的TCP/IP方式进行通信(在本地网中有固有的地址)
2. 移动结点漫游到一个外地网络时，仍然使用固定的IP地址进行通信。为了能够收到通信对端发给它的IP分组，移动结点需要向本地代理注册当前的位置地址，这个位置地址就是转交地址(可以是外部代理的地址或动态配置的一个地址)
3. 本地代理接收来自转交地址的注册后，会构造一条通向转交地址的隧道，将截获的发给移动结点的IP分组通过隧道送到转交地址处
4. 在转交地址处解除隧道封装，恢复原始的IP分组，最后送到移动结点，这样移动结点在外网就能够收到这些发送给它的分组
5. 移动结点在外网通过外网的路由器或外部代理向通信对端发送IP数据包
6. 移动结点来到另一个外网时，只需向本地代理更新注册的转交地址，就可继续通信
7. 移动地址回到本地网时，移动结点向本地代理注销转交地址，这时移动结点又将使用传统的TCP/IP方式进行通信

即移动地址为移动主机设置了两个IP地址，即主地址和辅地址(转交地址)。移动主机在本地网络时，使用主地址。当移动到另一个网络时，需要获得一个临时的辅地址，但此时主地址仍然不变。从外地移动会本地网时，辅地址改变或撤销，而主地址还不变

移动到另一个主机后，既不能直接接收分组也不能直接发送分组

## 网络层设备

见上

# 传输层

## 传输层提供的服务

### 传输层的功能

传输层一般是只有主机才有的层次，一般的设备只有三层

1. 提供进程与进程之间的逻辑通信

2. 复用和分用

	复用：不同的进程能同一一个传输层协议传输

	分页：不同的报文段能交付给用户

3. **对收到的报文进行差错检验，而因为网络层只对IP首部进行校验，故两者相加可以得到可靠的传输**

### 两个协议

|          |                             TCP                              |                        UDP                         |
| :------: | :----------------------------------------------------------: | :------------------------------------------------: |
|   描述   |                        面向连接、可靠                        |                   无连接，不可靠                   |
| 数据单位 |                            报文段                            |               数据报(二者统称报文段)               |
|   特点   | 传输数据前先建立连接，传输完数据后释放连接；不提供广播或组播服务；但其面向连接，故开销增加，因为有确认、流量控制、计时器及连接管理等操作 | 传输数据前不需要建立连接，接收到数据后也不需要确认 |
|  优缺点  |             可靠、面向连接、时延大、适用于大文件             |        不可靠、无连接、时延小、适用于小文件        |

### 传输层的寻址和端口

#### 一些概念

复用：应用层所有协议都可以通过传输层再传输到网络层

分用：传输层从网络层收到数据后交付给指明的应用进程

软件端口(逻辑端口)：传输层的SAP，标识主机中的进程；只有本地意义，在因特网中不同PC端口之间无联系

硬件端口：如路由器上的硬件接口

**端口：长度为16bit，能表示65536个端口**

按范围分为

![image-20220831192234367](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220831192234367.png)

#### 套接字

在网络中利用发送方和接受方的套接字组合来识别端口，**套接字唯一标识了网络上的一个主机及其进程**
$$
Socket=(主机IP地址,端口号)
\tag{1}
$$

## UDP

### 概述

UDP只在IP上加了很少的功能，即复用分用+差错检测

**特点**

1. UDP是无连接的，减少开销和发送数据之前的时延

2. UDP尽最大努力传输，即不保证可靠传输，可靠交付由应用层保证

3. UDP是面向报文的，适合一次性传输少量数据的网络应用

	UDP的对应用层报文不切分，不处理，直接传输，由应用层决定UDP报文长度，否则网络层会分配；若太小则数据传输率低，太大则网络层分片

	![image-20220831192904089](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220831192904089.png)

4. UDP无拥塞控制，实时性强，适用于FaceTime等

5. 首部开销小，只有8B，而TCP20B

### UDP数据报

![image-20220831193037194](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220831193037194.png)

### UDP检验

![image-20220831193236321](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220831193236321.png)

## TCP

### TCP协议特点

1. 面向连接(虚连接)的传输层协议

2. 每条TCP连接只能有两个端点，每条TCP连接只能是点对点的

3. 提供可靠交付的服务，无差错、不丢失、不重复、按序道道

4. 提供全双工通信

	发送缓存：准备发送的数据 & 发送但未收到确认的数据

	接受缓存：按序到达但未被应用程序读取的数据 & 不按序到达的数据

5. 面向字节流，将数据看成一连串的无结构字节流

### TCP报文段

![image-20220831194032852](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220831194032852.png)

1. 序号 seq

	在TCP连接中传送的字节流中每个字节都按顺序编号，本字段表示**本报文段发送数据的第一个字节的序号**

2. 确认号 ack

	**期望收到对方下一个报文段的第一个数据字段的序号。若确认号为N，则表示到N-1为止的所有数据都正确收到**

3. 数据偏移(**首部长度**)：4位

	**TCP报文段的数据起始处距离TCP报文段的起始处有多远**，**以4B为单位**，即1个数据是4B

	首部最小为20B，最大为60B

4. 6个控制位

	**紧急位URG**：**URG=1时，标明此报文段中有紧急数据**，是高优先级的数据，应尽快传送，不用排队，配合紧急指针字段使用

	**确认位ACK**：**ACK=1时确认号有效**，在连接建立后所有传输的报文段ACK都必须为1

	推送位PSH：**PSH=1时，接收方应尽快交付接受应用进程**，不再等待缓存填满时交付

	复位RST：**RST=1，表示TCP连接中出现严重错误，必须释放连接，然后再重新建立传输连接**

	**同步位SYN**：**SYN=1时，表示是一个连接请求/连接接受报文**

	**终止位FIN**：**FIN=1时，标明此报文段发送方数据已发完，请求释放连接**

5. 窗口

	发送本报文段的一方的接受窗口，即现在允许对方发送的数据量

6. 校验和

	**检验首部+数据，检验时需要加上12B伪首部，第四个字段为6**

7. 紧急指针

	**URG=1是有效，指出本报文段中紧急数据的字节数**

8. 选项

	一些可选字段

9. 填充：保证首部字段为4B整数倍

### TCP往返时延

将超时重传时间记为RTO

- TCP保留了RTT的一个**加权平均往返时间$RTT_s$**，这被称为平滑的往返时间

- 第一个测量到RTT样本时，$RTT_s$值就取为所测量到的RTT样本值。以后每测量到一个新的RTT样本，就按下式重新计算一次$RTT_s$
	$$
	新的RTT_s=(1 - \alpha)*(旧的RTT_s) + \alpha*(新的RTT样本)式中，0 \le \alpha \lt 1
	\tag{1}
	$$

- 当$\alpha$很接近于零，表示RTT值更新较慢。若选择$\alpha$接近于1，则表示RTT值更新较快

- 推荐$\alpha$值为$\frac{1}{8}$

- RTO应略大于上面得出的加权平均往返时间$RTT_s$
	$$
	RTO=RTT_s+4*RTT_D
	\tag{1}
	$$
	$RTT_D$是RTT的偏差的加权平均值

	第一次测量时，$RTT_D$zhi 取为测量到的$RTT$样本值的一半。在以后的测量中，则使下式计算加权平均的$RTT_D$
	$$
	新的RTT_D=(1- \beta)*(旧的RTT_D)+ \beta*|RTT_s-新的RTT样本|
	\tag{2}
	$$

- $\beta$是一个小于1的系数，其推荐值为$\frac{1}{4}$

- Karm算法

	在计算平均往返时间RTT时，只要报文段重传了，就不采用其往返时间样本

	这样得出的加权平均平均往返时间$RTT_s$和超时重传时间RTO就较为准确

	报文段每重传一次，就把RTO增大一些
	$$
	新的RTO= \gamma * (旧的RTO)
	\tag{1}
	$$
	系数$\gamma$的典型值为2

- 当不再发生报文段的重传时，才根据报文段的往返时延更新平均往返时延RTT和超时重传时间RTO的数值

### TCP连接管理

TCP连接由两个套接字确定

#### 三阶段

$连接建立 \to 传输数据 \to 连接释放$

##### 连接建立

采用C/S方式，主动发起者为客户，被动等待者为服务器

重点在于“**三次握手**”

![image-20220901191857627](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220901191857627.png)

- SYN=1，表示在连接请求和其接受阶段
- seq为序号(一开始为随机)
- ACK为确认位
- 有ACK就有ack(期望下一个发送的字节)
- 第三步可以携带数据，若不携带数据则不消耗序号

服务器端的资源是在完成第二次握手时分配的，而客户端的资源是在第三次握手时分配的，这就使得服务器易于受到SYN洪泛攻击

> SYN洪泛攻击：攻击者一直发第一个报文而不发第二个，即TCP连接卡在第二步，会使服务器一直挂起连接，导致过多死机
>
> 解决方法：设置SYN cookie

**重点问题**

1. TCP为什么需要三次握手？而不是两次？

	不是两次的主要原因是为了防止多次连接导致连接混乱

	比如A主机网络较差，第一个连接请求报文在网络某个结点长期滞留，A超时后认为该报文丢失，于是再重传一次连接请求，B收到后建立连接。数据传输结束后双方断开连接。而此时，A发出的前一个滞留在网络中的连接请求到达服务器B，而B认为A又发来连接请求，此时若使用三次握手，B将向A返回确认报文段，由于是一个已经失败的请求，因此A不予理睬，建立连接时报。若采用的是两次握手，这种情况下B认为连接已经建立，并一直等待A传输数据，而A此时并无连接请求，因此不理睬，这样就造成了B的资源白白浪费

2. 那可不可以是四次、五次或者更多次

	可以，但没必要，三次已经足够满足需求了，多次握手可能导致资源的浪费

##### 连接释放

![image-20220901194053313](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220901194053313.png)

- FIN：结束

- seq：序号

- ACK：确认

- ack：确认号

- 如果4丢失，则客户端会在2MSL中一直等待，在此期间客户端会收到所有服务器发送的报文，之后如果客户端还要关则再发一次4报文

	若不等2MSL，则服务器会一直发送报文，而客户端不接受，则寄

**重点问题**

为何不采用“三次握手”释放连接，且发送最后一次握手报文需要等待2MSL的时间呢？

1. 保证A发送的最后一个确认报文能到达B，如果A不等待2MSL，若A返回的最后确认报文段丢失，则B不能进入正常关闭状态，而此时A已经关闭，也不可能重传确认报文段
2. 防止出现“已失效的连接请求报文段”。A在发送最后一个确认报文段后，再经过2MSL可保证本连接持续的时间内所产生的所有报文段从网络中消失，产生这种现象的原因类似不采用两次握手所描述情形

故因此服务端比客户端早结束TCP连接一些，因为客户端需要等待2MSL

#### 总结

TCP连接建立和释放的总结如下：

1. 连接建立，分三步

	第一步(客户端)：SYN=1, seq=u

	第二步(服务端)：SYN=1, ACK=1, seq=v, ack=u+1

	第三步(客户端)：ACK=1, seq=u+1, ack=v+1

2. 连接释放，分四步

	第一步(客户端)：FIN=1, seq=u

	第二步(服务端)：ACK=1, seq=v, ack=u+1

	在此期间还可以服务端再传输一些数据

	第三步(服务端)：FIN=1, ACK=1, seq=w, ack=u+1

	第四步(客户端)：ACK=1, seq=u+1, ack=w+1

### TCP可靠传输

在IP层不可靠的、尽力交付的服务的基础上建立可靠数据传输，即发什么就收什么

TCP使用了**校验、序号、确认和重传机制**来达到这一目的

#### 序号

TCP首部的序号字段用来**保证数据能有序提交给应用层**，TCP把数据视为一个无结构但有序的字节流，序号建立在传输的字节流上，而不是报文端上

TCP连接传送的数据流中每个字节都编上一个序号。**序号字段的值是指本报文段所发送的数据的第一个字节的序号**。如图所示，*假设A和B之间建立了1条TCP连接，A的发送缓存区中共有10B，序号从0开始标号，第一个报文包含第0~2个字节，则该TCP报文段的序号是0，第二个报文段的序号是3*

![image-20220902192030260](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220902192030260.png)

#### 确认

**TCP首部的确认号是期望收到对方的下一个报文段的数据的第一个字节的序号。**在上图中，如果接收方B已收到第一个报文段，此时B希望收到的下一个报文段的数据从第三个字节开始的，那么B发送给A的报文中确认号应为3。**发送方缓存区中会继续存储那些已发送但未收到确认的报文段，以便在需要时重传**

**TCP默认使用累计重传，即TCP只确认数据流至第一个丢失字节为止的字节。**例如，在上图中接收方收到了A发送的包含字节0\~2及字节6\~7的报文段。由于某种原因，B还未收到3~5的报文段，此时B仍在等待字节3(和其后面的字节)，因此B到A的下一个报文段将确认号字段设置为3

#### 重传

TCP发送方在规定时间内没有收到确认就重传已发送的报文段(超时时间过短则可能发送冗余数据，过长则存在空闲时间)，故**TCP采用自适应算法，动态改变重传时间RTTs(加权平均往返时间)**

##### 冗余ACK(冗余确认)

每当比期望序号大的报文段到达时，发送一个冗余ACK，指明下一个期望的序号

![image-20220902193224290](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220902193224290.png)

### TCP流量控制

使用滑动窗口机制实现，**控制发送方发送速度**

在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，即接收窗口rwnd(接收方设置确认报文段的**窗口字段**来将rwnd通知给发送方)，发送方的**==发送窗口取接收窗口rwnd和拥塞窗口cwnd的最小值==**

![image-20220902194313456](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220902194313456.png)

> TCP为每个连接都设有一个持续计时器，只要TCP一方收到对方的零窗口通知，就启动持续计时器，若到期则发送一个零窗口探测报文段，接收方收到报文段时给出现在的窗口值，若还是0则重新设置计时器

### TCP拥塞控制

TCP拥塞控制主要用来**防止过多的数据注入网络**(全局性)

出现拥塞条件：$对资源需求的总和 \gt 可用资源$

#### 四种算法(慢开始、拥塞避免、快重传、快恢复)

假设：

1. 数据单方向传输，而另一方向只传送确认

2. 接收方总是有足够大的缓存空间，因而发送窗口大小取决于拥塞程度

	$发送窗口=Min(接收窗口rwnd,拥塞窗口cwnd)$

接收窗口：**接收方根据接受缓存设置的值，并告知给发送方，反映接收方容量**

拥塞窗口：**发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络当前容量**

##### 慢开始、拥塞避免

![image-20220902195814660](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220902195814660.png)

> ![image-20220902195931146](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220902195931146.png)

##### 快重传、快恢复

![image-20220902200022050](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220902200022050.png)

![image-20220902200111978](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220902200111978.png)

# 应用层

牢固掌握本章几个典型应用层协议是关键

## 网络应用模型

应用层为应用程序的通信提供服务

应用层协议定义什么？

1. 应用层进程交换的报文类型，请求还是响应？
2. 各种报文语法，如报文中的各个字段及其详细描述
3. 字段的语义，即包含在字段中的信息的定义
4. 进程何时如何发送报文，以及对报文进行响应的规则

|       应用层功能       |  对应协议  |
| :--------------------: | :--------: |
|  文件传输、访问、管理  |    FTP     |
|        电子邮箱        | SMTP、POP3 |
|        虚拟终端        |    HTTP    |
| 查询服务和远程作业登录 |    DNS     |

### 客户/服务器模型(C/S)

服务器：提供计算服务的设备

1. 永久提供服务
2. 永久性访问地址/域名

客户端：请求计算服务的设备

1. 与服务器通信，使用服务器提供的服务
2. 间歇性接入网络
3. 可能使用动态IP地址
4. 不与其他客户机直接通信

### P2P模型

特点如下：

1. **不存在永远在线的服务器**
2. 每个主机既可以**提供服务**，也可以**请求服务**
3. 任意端系统/节点之间可以**直接通讯**
4. 节点间歇接入网络
5. 节点可以改变IP地址
6. 可扩展性好
7. 网络健壮性强

## 域名系统(DNS)

主要负责将域名转换为IP地址(remind：IP转换成MAC是ARP协议)

### 层次域名空间

![image-20220904185945607](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220904185945607.png)

### 域名服务器

1. 根域名服务器

	最高层次的域名服务器，**所有根域名服务器斗志到所有的顶级域名服务器的IP地址**。根域名服务器也是最重要的域名服务器，不管是哪个本地域名服务器，**若要对因特网上的任何一个域名进行解析，只要自己无法解析，就首先要求助于根域名服务器**。因特网上有13个根域名服务器，这些服务器实际上是冗余服务器的集群，以提供安全性和可靠性。

	**根域名服务器用来管理顶级域(如.com)，通常它并不作为把待查询的域名直接转换为IP地址，而是告诉本地域名服务器下一步应当找哪个顶级域名服务器进行查询**

	上层知道下层，若下层已知，则不向上传递

2. 顶级域名服务器

	负责管理在该顶级域名服务器注册的所有二级域名。收到DNS查询请求时，就给出相应的回答(可能是最后的结果，也可能时下一步应当查询的域名服务器的IP地址)

3. 授权域名服务器(权限域名服务器)

	每台主机都必须在授权域名服务器处登记。为了更加可靠地工作，一台主机最好至少有两个授权域名服务器。**实际上，许多域名服务器都同时充当本地域名服务器和授权域名服务器。授权域名服务器总能将其管辖的主机名转换为该主机的IP地址**

	  负责一个区，若权限找不到就让另一个查

4. 本地域名服务器

	本地域名服务器对域名系统非常重要。每个因特网服务提供者(ISP)，或一所大学，甚至一个院系，都可以有一个本地域名服务器。当一台主机发出DNS查询请求时，这个查询请求报文就发送给该主机的本地域名服务器。

	事实上，在Windows系统中配置本地连接时，就需要填写DNS地址，这个地址就是本地域名服务器的地址

	但本地域名服务器不属于DNS层次结构

	![image-20220905182311615](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220905182311615.png)

### 域名解析过程

1. 递归查询

	靠别人

	$主机 \to 本地域名服务器 \to 根域名服务器 \to 顶级域名服务器 \to 权限域名服务器$

2. 迭代查询

	查自己，靠本地

	![image-20220905183005798](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220905183005798.png)

可以使用高速缓存加快DNS过程，有定期更新(本地域名、主机)，先查主机，本地的高速缓存，在走上述内容

![image-20220905183425327](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220905183425327.png)

## 文件传输协议(FTP)

简单文件传输使用TFTP(小，易于实现)，方便小文件，UDP

**FTP：提供不同种类主机系统(硬件、软件体系等都可以不同)之间的文件传输能力，可将上传、下载看作不同方向的拷贝**

### 工作原理

**FTP是基于C/S的协议，工作端口是20、21号**

- FTP服务器：依照FTP协议提供服务，进行文件传送的计算机
- FTP客户端：连接FTP服务器，遵循FTP协议与服务器传文件的主机

服务器监听21端口，等待客户连接；

![image-20220905184638047](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220905184638047.png)

是否使用20端口传文件与传输模式有关

- 主动PORT：客户端连接到服务器的21端口，登录成功后要读取数据时，客户端随机开放一个端口，并发送命令告知服务器，服务器收到PORT命令和端口后，通过20端口和客户端开放的端口连接，发送数据
- 被动PASV：客户端要读取数据时，发送PASV命令到服务器，服务器在本地随机开放一个端口，并告知客户端，客户端再连接到服务器开放的端口进行数据传输
- 是用PORT模式还是PASV模式，选择权再客户端
- 主动模式传送数据是服务器连接到客户端的端口；被动模式传送数据是客户端连接到服务器的端口

FTP传输模式

1. 文本：ASCII模式，以文本序列传输
2. 二进制：Binary，以二进制序列传输

## 电子邮件

### 电子邮箱格式

![image-20220905190404084](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220905190404084.png)

### 电子邮箱系统的组成结构

总共有三部分：用户代理、邮件服务器、相关协议

![image-20220905190622842](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220905190622842.png)

### SMTP和POP3

#### SMTP

使用TCP协议，端口号为25，采用C/S模式；

**规定了两个相互通信的SMTP进程之间应如何交换信息**，发的为SMTP客户端，收的为SMTP服务器

规定了14条命令(几个字母)，21种应答信息

有三个阶段：$连接建立 \to 邮件传送 \to 连接释放$；发送时会放在邮件缓存，等待周期时间发送

![image-20220906192653084](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220906192653084.png)

#### MIME

是一种扩充SMTP的协议

SMTP的缺点

1. 不能传输可执行文件或者其他二进制对象
2. SMTP仅限于传输7位ASCII码，不能传送其他非英语国家的文字
3. SMTP服务器会拒绝超过一定长度的邮件

![image-20220906193057307](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220906193057307.png)

#### POP3

使用TCP协议，端口号为110，采用C/S模式

多用于接收邮件，有两者工作方式

1. 下载并保存：用户在下载邮件后，服务器还会保留该邮件，可供再次下载
2. 下载并删除：用户下载后服务器就删除邮件

#### IMAP

也是一种邮件接收协议，但比POP3更复杂

PC上的IMAP客户机程序打开服务器时，用户可以看到邮件首部；若用户打开该邮件，该邮件才会上传到用户计算机上

**可以在不同地方用不同的PC随意读取，允许只读邮件的一部分**

#### 基于万维网的电子邮件

方便使用，比如QQ邮箱

在同公司邮箱之间(QQ邮箱之间)传输使用HTTP协议，而在不同公司之间则使用SMTP协议

![image-20220906193738955](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220906193738955.png)

## 万维网和HTTP

### 万维网

![image-20220906193919908](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220906193919908.png)

> - URL：统一资源定位符
> - HTTP：超文本传输协议
> - HTML：超文本标记语言

### HTTP

HTTP规定了浏览器如何向万维网服务器请求万维网文档，已经服务器怎样把文档传送给浏览器

![image-20220906194154146](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220906194154146.png)

**特点**

1. HTTP本身是无状态的即两次访问相应一致

	为了识别用户，可以用Cookie(存放在用户主机中)，记录一段时间内用户的访问记录

	> |            |                          无状态协议                          |                          有状态协议                          |
	> | :--------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
	> |    定义    | 无状态协议是一种网络协议，**其中客户端将请求发送到服务器，服务器根据给定状态返回响应** | 有状态协议是一种网络协议，其中，**如果客户端向服务器发送请求，则它期望某种响应，如果没有响应，则它重新发送该请求** |
	> |    例子    | HTTP（超文本传输协议），UDP（用户数据报协议），DNS（域名系统） |                 FTP（文件传输协议），Telnet                  |
	> | 服务器限制 | **在“无状态”中，不需要服务器将服务器信息或会话详细信息保留给自己** |       **在有状态时，需要服务器维护当前状态和会话信息**       |
	> |   相依性   | 在无状态情况下，服务器和客户端之间是松散耦合的，可以独立运行 |            在有状态时，服务器和客户端是紧密绑定的            |
	> |    设计    |                      服务器设计易于实现                      |                 服务器设计相对复杂且难以实施                 |
	> |  防撞证明  |                故障服务器可以在崩溃后轻松重启                |     服务器必须保留会话信息和其他详细信息。崩溃管理很困难     |
	> |  事务次数  |                 服务器以非常快的方式处理事务                 |                         服务器比较慢                         |

2. HTTP采用TCP作为传输层协议，但HTTP协议本身无连接

	即通信双方不建立HTTP连接

3. 底层TCP连接方式

	1.持久连接(keep-alive)：非流水线形和流水线形

	2.非持久连接(close)：每次连接都三次握手，故耗时长

	![image-20220906194703576](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220906194703576.png)

**报文结构**

有两种类型：HTTP请求报文(Request)和HTTP响应报文(Response)；**面向文本，故在报文中的字段都是ASCII码**

![image-20220906194845364](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220906194845364.png)

## 总结

| 常用协议 |                             功能                             | 下层使用什么实现 |                            端口号                            |
| :------: | :----------------------------------------------------------: | :--------------: | :----------------------------------------------------------: |
|   DNS    |                      将域名转换为IP地址                      |                  |                              53                              |
|   TFTP   |                         简单文件传输                         |       UDP        |                              69                              |
|   FTP    | 提供不同种类主机系统之间的文件传输，可以将上传、下载看作不同方向的拷贝；基于C/S模型 |       TCP        | 21端口监听客户端连接；20端口传输数据(按照传输模式来看是否使用20端口) |
|   SMTP   | **规定了两个相互通信的SMTP进程之间应如何交换信息**，发的为SMTP客户端，收的为SMTP服务器；多用于邮件发送 |       TCP        |                              25                              |
|   POP3   |                        多用于接收邮件                        |       TCP        |                             110                              |
|  TELNET  |                           远程登录                           |       TCP        |                              23                              |
|   HTTP   | 超文本传输协议；规定了浏览器如何向万维网服务器请求万维网文档，已经服务器怎样把文档传送给浏览器 |       TCP        |                              80                              |
|   SNMP   | 用于在 IP 网络管理[网络节点](https://baike.baidu.com/item/网络节点?fromModule=lemma_inlink)（[服务器](https://baike.baidu.com/item/服务器?fromModule=lemma_inlink)、[工作站](https://baike.baidu.com/item/工作站?fromModule=lemma_inlink)、[路由器](https://baike.baidu.com/item/路由器?fromModule=lemma_inlink)、[交换机](https://baike.baidu.com/item/交换机?fromModule=lemma_inlink)及HUBS等）的一种标准协议 |       UDP        |                             161                              |

# 一些易错点

## 计算机网络体系结构

1. TCP/IP模型中网络接口层对于OSI参考模型的物理层和数据链路层
2. 因特网采用的核心技术是TCP/IP
3. 广播式网络一般只包含2层，即物理层、数据链路层；没有网络层是因为广播式网络不需要进行路由选择

## 物理层

1. 码元传输速率：**单位时间内数字通信系统所传输的码元个数(脉冲个数或信号变化次数)**

	注意码元传输速率(Band)与数据传输速率(bit/s)之间的关系

	若一个码元携带$n$ bit的信息量，则$M$ B的码元传输速率对应的信息传输速率为$M*n$ bit/s

2. 异步传输：一次传输一个字符(5~8位组成)，每个字符用一个起始符引导，同一个停止码结束，如果没有数据发送，发送方可以连续发送停止码

3. **同步传输以帧(数据块)为单位，异步传输以字节为单位**

4. 10Base-T以太网：

	10BaseT是传送**基带信号**的**双绞线**以太网，T表示采用的是黄教先，10BaseT现在使用的是**无屏蔽双绞线**(UTP)，传输速度是**10Mbps**

	**物理上采用星形拓扑，逻辑上总线型，每段双绞线最长100m**

	采用**曼彻斯特编码**(先1后0为0，先0后1为1)，并采用CSMA/CD介质访问控制协议

5. 物理层接口特性

	机械特性：接口所用……

	电气特性：电压范围

	功能特性：电压的意义

	过程特性(规程特性)：事件出现顺序

## 数据链路层

1. 连续ARQ协议大体上是停等协议一次发多个，其可细分为回退n帧连续ARQ和选择重传ARQ，默认采用回退n帧

2. **10Base5、10Base2、10Base-T、10Base-F等等的含义**

  Base表示电缆上的信号是基带信号，采用曼彻斯特编码；BROAD表示宽带信号

  Base前面的数字表示数据传输速率，后面的数字表示每一段电缆最大长度

  | 网络类型  | 含义                                   |
  | --------- | -------------------------------------- |
  | 10Base5   | 10Mbit/s，基带信号，每段电缆最长500m   |
  | 10Base2   | 10Mbit/s，基带信号，每段电缆最长200m   |
  | 10Base-T  | 10Mbit/s，基带信号，采用双绞线的以太网 |
  | 10Base-F  | 10Mbit/s，基带信号，采用光纤的以太网   |
  | 1Base5    | 1Mbit/s，基带信号，每段电缆最长500m    |
  | 10BROAD36 | 10Mbit/s，宽带信号，每段电缆最长3600m  |

3. **PPP的特殊字符填充法就是将7E变成7D5E、将7D变成7D5D**

4. 交换机(网桥)的转发表建立过程，见一些重要的数据结构–转发表(网桥&交换机)

5. 对于窗口大小为n的滑动窗口，对于回退N帧协议来说发送窗口的大小可以达到窗口总数-1，即最多可以有n-1帧已发送但没有确认

6. 循环冗余校验需要商定才能使用多项式编码

7. **信道利用率**
	$$
	利用率=\frac{\frac{L(比特)}{C(发送方数据传输率)}}{T(发送周期)} \\
	吞吐量=利用率*发送速率
	\tag{1}
	$$
	发送周期=发一个帧的时间+RTT；而总发送时间=发送所有帧的时间

8. 以太网最小帧的长度是64B，其中包括了在以太网帧头部的地址、类型域和帧尾部的校验和域。这些部分的总长度是18B

9. PPP主要有3个部分

	- 一种将IP数据报封装到串行链路的方法
	- 一个链路控制协议(LCP)。其用于建立、配置和测试链路连接，并在它们不需要时将它们释放
	- 一套网络控制协议(NCP)。其中每个协议支持不同的网络层协议，用来建立和配置不同的网络层协议

10. HDLC中，帧为3类，分别为信息帧、监控帧和无编号帧，采用比特填充法

11. **直通交换方式**是指以太网交换机可以在各端口间交换数据。它在输入输出端口检测到一个数据包时，检查该包的包头，获取包的目的地址，启动内部的动态查找表转换成相应的输出端口，在输入域输出交叉处接通，把数据包直通到相应的端口，实现交换功能

	通常情况下，直通交换方式只检查数据包的包头即前14各字节，由于不需要考虑前导码，只需要检测目的地址的6B，所以最短的传输时延为$\frac{48}{v}$

12. **数据链路(逻辑链路)和链路(物理链路)有何区别？**

	**区别在于数据链路除了本身是一条链路外，还必须有一些必须的规程来控制数据的传输**。因此，数据链路比链路多了实现通信规程所需要的硬件和软件

13. **“电路连通了”和“数据链路连通了”的区别何在？**

	**“电路连通了”**表示链路两端的节点交换机已经开机，物理连接已经能够传送比特流了。但是数据连接并不可靠。

	在物理连接的基础上再建立数据链路连接，才是**”数据链路连通了“**。此后，由于数据链路连接具有检测、确认和重传等功能，才使得不太可靠的物理链路变成可靠的数据传输。当数据链路断开连接时，物理连接不一定跟着断开

14. **有人指出：每一帧的结束处是一个标志字节，而下一帧的开始处又是另一个标志字段，这种做法是对空间的浪费。如果只使用一个标志字节可以完成相同的工作，那么就可以省下一个字节。这种说法有错吗？**

	加入数据链路层的字节流是一直连续不断的，那么采用一个字节的标志是可以分清不同帧之间的界限的。但是如果一个帧结束了传递，以flag字节结束，之后的15min内没有新的帧传输。在这种情况下，接收方无法确认下一个到来的字节是一个新的帧开始，还是链路上的噪声。采用开始和结束都添加标志字节的方法，可以大大简化数据链路层协议的设计

15. **选择重传协议在什么情况下和连续ARQ协议在效果上一致？**

	选择重传ARQ协议是在连续重传ARQ协议的基础上增加了接收窗口的数目，实现对于传输出现差错的帧的选择性重传。即接收窗口在实际应用中等于1时，选择重传ARQ协议退化成连续ARQ协议

## 网络层

1. **RIP使用UDP，OSPF使用IP，而BGP使用TCP，这样做有何优点？为什么RIP周期性地和邻站交换路由信息，而BGP不这样做？**

  RIP处于UDP的上层，RIP所接收的路由信息都封装在UDP数据报中；OSPF位于网络层，由于要交换的信息量较大，所有应使报文的长度尽可能短；BGP需要在不同的自治系统之间交换路由信息，由于网络环境复杂，需要保证可靠地传输，所以使用TCP

  内部网络协议主要是设法使数据报在一个自治系统中尽可能有效地从源站传送到目的站，在一个自治系统内部并不需要考虑其他方面的策略，然而BGP使用的环境不同，主要有以下三个原因

  - 因特网规模过大，使得自治系统之间的路由选择十分困难

  - 对于自治系统之间的路由，寻找最佳路由是不现实的

  - 自治系统之间的路由选择必须考虑有关策略

    由于以上情况，BGP只能力求找到一条交换的路由，所以BGP不需要像RIP一样周期性地和邻站交换路由信息

2. IPv6地址压缩方法

	冒号16进制记法，如*4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170*

	压缩：连续的4个0只记一个，如*4BF5:0:0:BA5F:391:A:2176*

	零压缩：一连串连续的0用一对冒号取代，只能用一次

	一般来说合并前导0

	- 0000:0000:0F53:6382:AB00:67DB:BB27:7332		::F53:6382:AB00:67DB:BB27:7332
	  - 0000:0000:0000:0000:0000:0000:004D:ABCD        ::4D:ABCD
	  - 0000:0000:0000:AF36:7328:000A:87AA:0398         ::AF36:7328:A:87AA:398
	  - 2819:00AF:0000:0000:0000:0035:0CB2:B271         2819:AF::35:CB2:B271

3. 拥塞是指在某段时间内，如果对网络中某一资源的需求超过了该资源提高的可用部分，网络的性能就会明显变差。发送拥堵时，网络的性能将急剧下降，整个网络的吞吐量就会随着网络负载的增加而不断下降。在网络正常运行时，网络的吞吐量将随网络负载的增加而线性增加。因此**判断网络是否出现拥塞的依据是网络的吞吐量是否随着负载的增加而不断下降**

4. **本层及本层以下的协议可以不同，但高层协议必须相同**

5. **路由选择分为直接交付和间接交付**，当两台主机位于同一物理网段内时，就使用直接交付，反之使用间接交付；间接交付的最后一个路由器一定是直接交付；直接交付位于同一物理网段内，所以不涉及路由器

6. 拥塞控制–防止数据报过多

	开环控制–静态：设计网络时就考虑好会不会拥塞

	闭环控制–动态：事先不考虑，采用检测网络系统区监视，及时检测哪里有拥塞

7. **路由收敛是指网络设备的路由表与网络拓扑结构保持一致**

8. **划分子网的好处是减小广播域的大小，为什么不是增加主机的数量呢？**

	以C类地址为例，本身能容纳254台主机，划分子网后，其主机数目一定少于254；

	其实划分子网仅仅只是使得IP地址利用率提高，并不会增加主机的数量

9. **CIDR技术的作用是把小的网络汇聚成大的超网**

10. **IPv6不允许分片**，故一台路由器接收的IPv6数据报因过大而不能转发到输出链路上时，路由器会把该报文丢弃

11. IGP：自治系统内路由协议；EGP：自治系统间路由协议

12.  RIP超过180s没收到认为邻居死了，OSPF每10s向各个接口发Hello分组，若连续4次没收到该分组就认为邻居死了

13. **为什么要划分子网？子网掩码的作用是什么？**

	由于因特网的每台主机都要分配一个唯一的IP地址，所以分配的IP地址很多，这将使路由器的路由表变得很大，进而影响了路由器在进行路由选择时的工作效率。解决这个问题的方法就是将一个大的网络划分为几个较小的网络，每个小的网络称为一个子网

	当一个分组到达一个路由器时，路由器应该能够判断出IP地址的网络号。子网掩码用来判断IP地址的哪一部分是网络号与子网号，哪一部分是主机号。为了完成这种分离，路由器将对IP地址和子网掩码进行与运算

14. **子网掩码不一定非要是连续的1和0，也可以断开，但一般使用连续的**

## 传输层

1. **为什么说UDP是面向报文的，而TCP是面向字节流的？**

	

# 重点考点

## 计算机网络体系结构

### OSI参考模型与TCP/IP模型

- TCP/IP参考模型有几层，每一层都是什么？
- OSI参考模型有几层，每一层是什么？
- TCP/IP参考模型与OSI参考模型的异同点是什么？两种模型各层次的对应关系是什么？

常以选择题或简答题为主

### 计算机网络协议、接口、服务等概念

以记忆知识点为主，多为选择题或简答题

### 计算机网络性能指标

难点在于计算时延，时延计算方法如下

#### ==三种交换时延计算方法==

1. 四种时延
	$$
	发送时延(传播时延)=\frac{数据块长度(bit)}{数据率(b/s)} \\
	传输时延=\frac{链路长度(m)}{传播速度(m/s)} \\
	处理时延=节点存储转发所用时间 \\
	排队时延=节点排队时间
	\tag{1}
	$$
	1在发送器中，2在链路上，34在节点中

2. 电路交换
	$$
	时延=建立连接时延+传输时延+传播时延 \quad (没有存储转发)
	\tag{2}
	$$

3. 报文交换
	$$
	发送时延(传播时延)=\frac{数据块长度(bit)}{数据率(b/s)}*链路数 \\
	传输时延=\frac{链路长度(m)}{传播速度(m/s)}*链路数 \\
	处理时延=节点存储转发所用时间=单个节点处理时延*节点数 \\
	排队时延=节点排队时间=单个节点排队时延*结点数
	\tag{3}
	$$

4. 分组交换
	$$
	发送时延(传播时延)=\frac{总分组长度(bit)}{单个分组数据长度(bit)}*\frac{单个分组长度(bit)}{数据率(b/s)}+节点数*\frac{单个分组长度(bit)}{数据率(b/s)} \\
	传输时延=\frac{链路长度(m)}{传播速度(m/s)} \\
	处理时延=最后一个节点的排队时延 \\
	排队时延=一个分组的排队时延
	\tag{4}
	$$

## 物理层

### 奈奎斯特定理和香农定理

#### 奈氏准则(奈奎斯特定理)

限制码元极限传输速率

**在理想低通(无噪音 带宽受限)条件下，为了避免码间串扰，极限码元传输速率为$2W$Band，W为信道带宽(Hz)；故极限数据传输速率为$2Wlog_2V$b/s，V为码元进制数**

#### 香农定理

**信噪比：用来衡量噪声对信号的影响**

$$信噪比=\frac{信号的平均速率}{噪声的平均速率}$$ 记为 $\frac{S}{N}$，并用分贝(dB)作为单位，即$信噪比(dB)=10log_{10}\frac{S}{N}$

在带宽受限且有噪声的信道中，为了不产生误差，数据传输速率有上限值，一般**给定信噪比dB求$\frac{S}{N}$**
$$
信道的极限数据传输速率=W*log_2(1+\frac{S}{N}) \qquad (b/s)
\tag{1}
$$

### 电路交换、报文交换与分组交换的工作方式与特点

#### 数据传输方式选择

- **传输数据量大，且传送事件远大于呼叫时间，采用电路交换**(电路时延最小)
- 端到端的通路有很多段的链路组成，采用分组交换
- 从信道利用率上来看，==**报文交换与分组交换优于电路交换，其中分组交换更优，尤其适合于计算机之间的突发通信**==
- ![image-20220728195213802](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220728195213802.png)

### 传输介质、物理层接口特性

多选择题

### 物理层设备

中继器：放大器

集线器：多端口中继器

## 数据链路层

### 流量控制与可靠传输机制

主要考察对滑动窗口机制的理解。可以在数据链路层考察，也可以在传输层考察。

**需要理解停止–等待协议、后退N帧协议和选择重传协议的发送窗口与接收窗口的大小如何变化、可靠传输需要传输哪些帧及传输过程如何进行**

一般两种题型

- **一种考查对滑动窗口机制的概念理解**，结合一定的使用场景，分析发送窗口、接收窗口的大小变化及其3种协议之间的关系。**应该注意最大发送窗口的概念**

- **结合性能指标，分析滑动窗口机制发送数据帧的过程，计算相关的性能指标**。

	首先分析使用该种滑动窗口机制时在一定时间内可以发送多少帧数据，进而计算出这段时间内发送的数据量大小，之后的计算过程就很简单了

### 介质访问控制

最常考的是随机介质访问控制

### 组帧的方法

主要有四个

- 普通数据链路帧

- 以太网MAC帧

	![image-20220919183037838](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220919183037838.png)

- PPP帧

	![image-20220919183055834](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220919183055834.png)

	**PPP的特殊字符填充法就是将7E变成7D5E、将7D变成7D5D**

- HDLC帧

	![image-20220919183133261](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220919183133261.png)

	使用比特填充法，每5个1填一个0

### 差错控制

- 检错

	奇偶校验码

	循环冗余码

- 纠错

	海明码

### 以太网的MAC帧

应对以太网帧格式有清晰的记忆，同时理解MAC帧的各字段长度及含义

## 网络层

### 子网划分和无分类编址CIDR

重点理解**子网划分的原理和无分类编址CIDR的概念**

本质上核心都是**掩码的概念**，给定一个IP地址，将IP地址和掩码做异或操作，得到其网络号或子网号，需要区分的是**子网掩码和掩码的描述以及表示形式**

路由聚合的过程，实际上仍然使用了掩码的概念，只不过将高位相同的地址进行合并，重新设计新的掩码

### IP地址的分类

应清晰记忆**==4类地址的范围，以及6种特殊的IP地址==**

![image-20220929193233116](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.assets/image-20220929193233116.png)

|      | 地址范围 |
| :--: | :------: |
| A类  |  1~126   |
| B类  | 128~191  |
| C类  | 192~223  |
| D类  | 224~239  |
| E类  | 240~256  |

| NetID网络号 | HostID主机号 | 作为IP地址的源地址 | 作为IP地址的目的地址 |                             用途                             |
| :---------: | :----------: | :----------------: | :------------------: | :----------------------------------------------------------: |
|     全0     |     全0      |        可以        |        不可以        | 表示本网范围内表示主机，路由表中用于表示默认路由(表示整个Internet网络) |
|     全0     |    特定值    |        可以        |        不可以        |                    表示本网中某个特定主机                    |
|     全1     |     全1      |       不可以       |         可以         | **整个TCP/IP网的广播地址，但路由器对广播域进行了隔离，故全1地址等效于本网的广播地址** |
|   特定值    |     全0      |       不可以       |        不可以        |                    网络地址，表示一个网络                    |
|   特定值    |     全1      |       不可以       |         可以         |         直接广播地址，对特定网络上的所有主机进行广播         |
|     127     |    任何数    |        可以        |         可以         | **用于本地换回网络测试**，称为换回地址；**目的地址为换回地址的IP数据报不会出现在任何网络上** |

**私有IP地址**

| 地址类别 |          地址范围           | 网段个数 |
| :------: | :-------------------------: | :------: |
|   A类    |   10.0.0.0~10.255.255.255   |    1     |
|   B类    |  172.16.0.0~172.31.255.255  |    16    |
|   C类    | 192.168.0.0~192.168.255.255 |   256    |

路由器对所有目的地址为私有地址的数据报都不转发

**分类IP网**

|      |    最大可用网络数     | 第一个可用的网络号 | 最后一个可用的网络号 |          最大主机数          |
| :--: | :-------------------: | :----------------: | :------------------: | :--------------------------: |
| A类  | 2^7-2，全0和127不可用 |         1          |         126          | 2^{24}-2，全0(本网)全1(广播) |
| B类  |  2^{14}-1，全0不可用  |       128.1        |       191.255        |           2^{16}-2           |
| C类  |  2^{22}-1，全0不可用  |      192.0.1       |     223.255.255      |            2^8-2             |

### IP数据报格式

应清晰记忆I**P数据报的格式**，理解**各字段的含义和长度**，==标志字段的MF和DF需要着重理解和记忆==

源地址、目的地址、片偏移、标志字段等信息都很重要

### 路由与转发

对路由表和路由转发有较为深入的理解，包括该路由表采用了何种IP地址格式、是否进行了子网划分、有无路由聚合等

### ARP、DHCP、ICMP

背三个协议就可以

### IPv6

==记忆IPv6的主要特点与地址格式==

常结合IPv4，进行IPv6和IPv4特点的比较

### 路由选择协议

深入理解三种路由选择协议的原理和路由表更新过程，核心是理解三种协议的原理，在此基础上根据条件进行路由表的更新和交换

### IP组播、移动IP的基本概念

理解IP组播的概念，记忆组播地址的范围，对于移动IP，着重理解其通信过程

